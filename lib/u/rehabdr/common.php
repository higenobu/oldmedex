<?php
include_once $_SERVER['DOCUMENT_ROOT'].'/lib/common.php';
include_once $_SERVER['DOCUMENT_ROOT'].'/lib/enum.php';
include_once $_SERVER['DOCUMENT_ROOT'].'/lib/ord_common.php';

/* do not show these for history diff */
$no_disp = array('ObjectID','Superseded');

$rehab_pd = array(
  "¥ê¥Ï½èÊý" => array('Íý³ØÎÅË¡','ºî¶ÈÎÅË¡','¸À¸ìÄ°³ÐÎÅË¡'),
  "½èÊý¶èÊ¬" => array('¿·µ¬','ÊÑ¹¹','Ãæ»ß','ºÆ³«','½ªÎ»'),
  "Ãæ»ßÍýÍ³" => array('°å³ØÅª°ÂÀÅÉ¬Í×','Àº¿À¾õÂÖ¤ÎµÞ·ã¤Ê°­²½',
		      'Ãø¤·¤¤·±ÎýµñÈÝ','Ãø¤·¤¤ÈèÏ«¡¦áÖÄË¤ÎÁÊ¤¨','Ãæ»ßÍýÍ³¤½¤ÎÂ¾'),
  "°Õ¼±¾ã³²" => array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'),
  "JCS" => array('-','¤À¤¤¤¿¤¤°Õ¼±À¶ÌÀ¤À¤¬¡¢¤¤¤Þ¤Ò¤È¤Ä¤Ï¤Ã¤­¤ê¤·¤Ê¤¤','¸«Åö¼±¾ã³²¤¬¤¢¤ë',
		 '¼«Ê¬¤ÎÌ¾Á°¡¢À¸Ç¯·îÆü¤¬¤¤¤¨¤Ê¤¤','ÉáÄÌ¤Î¸Æ¤Ó¤«¤±¤ÇÍÆ°×¤Ë³«´ã¤¹¤ë',
		 'Âç¤­¤ÊÀ¼¤Þ¤¿¤ÏÂÎ¤òÍÉ¤µ¤Ö¤ë¤³¤È¤Ë¤è¤ê³«´ã¤¹¤ë',
		 'ÄË¤ß»É·ã¤ò²Ã¤¨¤Ä¤Ä¸Æ¤Ó¤«¤±¤ò·«¤êÊÖ¤¹¤³¤È¤Ç¤«¤í¤¦¤¸¤Æ³«´ã¤¹¤ë',
		 'ÄË¤ß»É·ã¤ËÂÐ¤·¡¢Ê§¤¤¤Î¤±¤ë¤è¤¦¤ÊÆ°ºî¤ò¤¹¤ë',
		 'ÄË¤ß»É·ã¤Ç¾¯¤·¼êÂ­¤òÆ°¤«¤·¤¿¤ê¡¢´é¤ò¤·¤«¤á¤ë','ÄË¤ß»É·ã¤Ë³«´ã¤·¤Ê¤¤'),
  "ÃÔÊò" => array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'),
  "ÃÎÅª¾ã³²" => array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'),
  "Ãí°Õ¾ã³²" =>  array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'),
  "µ­²±¾ã³²" =>  array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'),
  "¼ºÇ§" =>  array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'),
  "¼º¹Ô" =>  array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'),
  "¼º¸ì" =>  array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'),
  "È¾Â¦»ë¶õ´ÖÌµ»ë" =>  array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'),
  "»ë³Ð¾ã³²" =>  array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'),
  "Ä°³Ð¾ã³²" =>  array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'),
  "É½ºß´¶³Ð¾ã³²" =>  array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'),
  "¿¼Éô´¶³Ð¾ã³²" =>  array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'),
  "ÄË¤ß" =>  array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'),
  "¹½²»¾ã³²" => array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'), 
  "¸ÆµÛ½Û´Ä´ïµ¡Ç½¾ã³²" => array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'), 
  "ÀÝ¿©µ¡Ç½¾ã³²" => array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'), 
  "ÇÓÇ¢µ¡Ç½¾ã³²" => array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'), 
  "ÇÓÊØµ¡Ç½¾ã³²" => array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'), 
  "Ãæ¿õÀ­Ëãáã" => array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'), 
  "¹´½Ì" =>  array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'),
  "¶ÚÎÏÄã²¼" =>  array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'),
  "ÃÐ´Ë" =>  array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'),
  "áÛÀ­" =>  array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'),
  "¸Ç½Ì" =>  array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'),
  "ÉÔ¿ï°Õ±¿Æ°" =>  array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'),
  "êóÁÏ" =>  array('¤Ê¤·','É¾²ÁÃæ','¤¢¤ê','ÉÔÌÀ','Ì¤³ÎÇ§'),
  "·±Îý·ÁÂÖ" => array('¥Ù¥Ã¥É¥µ¥¤¥É¤Î¤ß','·±Îý¼¼','ÉÂÅïÅù','·±Îý¼¼+ÉÂÅïÅù','²°³°·±Îý¤â²ÄÇ½'),
  "±¿Æ°»þ¥â¥Ë¥¿¡¼É¬Í×" => array('±¿Æ°»þ¥â¥Ë¥¿¡¼É¬Í×'),
  "°Õ¼±¥ì¥Ù¥ëÄã²¼" => array('°Õ¼±¥ì¥Ù¥ëÄã²¼'),
  "¤±¤¤¤ì¤ó¤Î½ÅÀÕ" => array('¤±¤¤¤ì¤ó¤Î½ÅÀÕ'),
  "ÂÎ²¹" => array('-','38.0','37.5','37.0'),
  "SPO2" => array('-','95','94','93','92','91','90','89','88','87','86','85'),
  "Anderson¤Î´ð½à" => array('84ºÐ°Ê²¼','85ºÐ°Ê¾å'),
  "´ðËÜÆ°ºîÇ½ÎÏ" => array('Êâ¹Ô','°Ü¾è¡¦¶îÆ°','Ã¼ºÂ°Ì','»Ù»ýºÂ°Ì',
			'²é¾²¡¦¿²ÊÖ¤ê','²é¾²¡¦¸½¾õ°Ý»ý'),
  "Ž¾ŽÙŽÌŽ¹Ž±Ç½ÎÏ" => array('ÆþÍá¥ì¥Ù¥ë','¹¹°á¥ì¥Ù¥ë','¥È¥¤¥ì¥ì¥Ù¥ë','À°ÍÆ¥ì¥Ù¥ë',
		      '¿©»ö¥ì¥Ù¥ë','Á´²ð½õ¥ì¥Ù¥ë'),
  "Ç§ÃÎÇ½ÎÏ" => array('¼«Î©','»þ¤Ë´Æ»ë','¾ï»þ´Æ»ë','»þ¤Ë²ð½õ','¾ï»þ²ð½õ','ÌµÈ¿±þ'),
  "´ØÀá²ÄÆ°°è·±Îý" => array('´ØÀá²ÄÆ°°è·±ÎýPT','´ØÀá²ÄÆ°°è·±ÎýOT'),
  "¶ÚÎÏÁý¶¯·±Îý" => array('¶ÚÎÏÁý¶¯·±ÎýPT','¶ÚÎÏÁý¶¯·±ÎýOT'),
  "¿À·Ð¶ÚºÆ¶µ°é" => array('¿À·Ð¶ÚºÆ¶µ°éPT','¿À·Ð¶ÚºÆ¶µ°éOT'),
  "¶¨Ä´À­·±Îý" => array('¶¨Ä´À­·±ÎýPT','¶¨Ä´À­·±ÎýOT'),
  "Á´¿ÈÄ´À°·±Îý" => array('Á´¿ÈÄ´À°·±ÎýPT','Á´¿ÈÄ´À°·±ÎýOT'),
  "¹ªåÌÆ°ºî·±Îý" => array('¹ªåÌÆ°ºî·±ÎýPT','¹ªåÌÆ°ºî·±ÎýOT'),
  "´ðËÜÆ°ºî·±Îý" => array('´ðËÜÆ°ºî·±ÎýPT','´ðËÜÆ°ºî·±ÎýOT'),
  "Æü¾ïÀ¸³è³èÆ°·±Îý" => array('Æü¾ïÀ¸³è³èÆ°·±ÎýPT','Æü¾ïÀ¸³è³èÆ°·±ÎýOT'),
  "Æü¾ï´ØÏ¢Æ°ºî·±Îý" => array('Æü¾ï´ØÏ¢Æ°ºî·±ÎýPT','Æü¾ï´ØÏ¢Æ°ºî·±ÎýOT'),
  "Ç§ÃÎ·±Îý" => array('Ç§ÃÎ·±ÎýPT','Ç§ÃÎ·±ÎýOT'),
  "ÉÂÅï´Ä¶­ÀßÄê" => array('ÉÂÅï´Ä¶­ÀßÄêPT','ÉÂÅï´Ä¶­ÀßÄêOT'),
  "ÊäÁõ¶ñ¡¦¼«½õ¶ñ¤Î¸¡Æ¤" => array('ÊäÁõ¶ñ¡¦¼«½õ¶ñ¤Î¸¡Æ¤PT','ÊäÁõ¶ñ¡¦¼«½õ¶ñ¤Î¸¡Æ¤OT'),
  "ºßÂðÉ¾²Á¡¦·±Îý" => array('ºßÂðÉ¾²Á¡¦·±ÎýPT','ºßÂðÉ¾²Á¡¦·±ÎýOT'),
  "»ýµ×ÎÏÉ¾²Á" => array('»ýµ×ÎÏÉ¾²ÁPT','»ýµ×ÎÏÉ¾²ÁOT'),
  "¤½¤ÎÂ¾ÆÃÄê¤ÎÉ¾²Á°ÍÍê" => array('¤½¤ÎÂ¾ÆÃÄê¤ÎÉ¾²Á°ÍÍêPT','¤½¤ÎÂ¾ÆÃÄê¤ÎÉ¾²Á°ÍÍêOT'),
  "Í­»ÀÁÇ±¿Æ°Êâ¹ÔTime" => array('-','40','20','15','10'),
  "Í­»ÀÁÇ±¿Æ°¼Ö°Ø»Ò¶îÆ°Time" => array('-','40','20','15','10'),
  "Í­»ÀÁÇ±¿Æ°µ¯µïÆ°ºîTime" => array('-','40','20','15','10'),
  "Í­»ÀÁÇ±¿Æ°ºÂ°Ì¤Ç¤ÎÁ´¿È±¿Æ°Time" => array('-','40','20','15','10'),
  "Í­»ÀÁÇ±¿Æ°¾õ¶·¤Ë±þ¤¸¤ÆTime" => array('-','40','20','15','10'),
  "¥Ù¥Ã¥É¥®¥ã¥Ã¥¸" => array('-','80','70','60','50','40','30','Ãæ»ß´ð½à°Ê³°¤ÎÈÏ°Ï¤Ç'),
  "¥Ù¥Ã¥É¥®¥ã¥Ã¥¸Time" => array('-','40','30','20','10'),
  "¥Ù¥Ã¥É¥®¥ã¥Ã¥¸Set" => array('-','3','2','1'),
  "¼º¸ì¾É·±Îý" => array('¼º¸ì¾É·±Îý','È¯¸ì¼º¹Ô·±Îý','Âå½þ¼êÃÊ¤Î¸¡Æ¤','´Ä¶­Ä´À°'),
  "¹½²»·±Îý" => array('¹½²»·±Îý'),
  "¹â¼¡Ç¾µ¡Ç½·±Îý" => array('¹â¼¡Ç¾µ¡Ç½·±ÎýST','¹â¼¡Ç¾µ¡Ç½·±ÎýOT','¹â¼¡Ç¾µ¡Ç½·±Îý'),
  "ÀÝ¿©Óë²¼·±Îý" => array('ÀÝ¿©Óë²¼·±Îý','ÀÝ¿©Óë²¼·±ÎýÉ¾²Á','Ä¾ÀÜ·±Îý','´ÖÀÜ·±Îý'),
  "Áí¹çÅª¸¡ºº" => array('SLTA','SLTAÊä½õ¸¡ºº','SALA','Ï··òÈÇ¼º¸ì¾É´ÕÊÌ¿ÇÃÇ¸¡ºº','WAB'),
  "Ä°¤¯²áÄø" => array('¥È¡¼¥¯¥ó¥Æ¥¹¥È','Íý²ò¸ì×Ã¸¡ºº','Ä°³ÐÅªÇÄ»ýÎÏ¸¡ºº',
			 'Ã±¸ì¤Î¥â¡¼¥éÊ¬²òÇ½ÎÏ¸¡ºº','Ã±¸ì¤Î¥â¡¼¥éÃê½ÐÇ½ÎÏ¸¡ºº','¸ì²»ÊÛÊÌ¸¡ºº'),
  "ÏÃ¤¹²áÄø" => array('100Ã±¸ì¸Æ¾Î¸¡ºº','Éü¾§¸¡ºº','È¯¸ì¼º¹Ô¸¡ºº'),
  "ÆÉ¤ß½ñ¤­²áÄø" => array('´Á»ú-²¾Ì¾¸¡ºº','²»ÆÉ¸¡ºº','ÆÉ²òÎÏ¸¡ºº','100Ã±¸ì½ñ¾Î¸¡ºº'),
  "¹½Ê¸Ç½ÎÏ" => array('¼º¸ì¾É¹½Ê¸¸¡ºº'),
  "CADL" => array('CADL'),
  "½ÅÅÙ¼º¸ì¾É¸¡ºº" => array('½ÅÅÙ¼º¸ì¾É¸¡ºº'),
  "¹½²»¸¡ºº" => array('¹½²»´ï´±¸¡ºº','Ã±¸ìÌÀÎÆÅÙ¸¡ºº','²ñÏÃÌÀÎÆÅÙÈ½Äê'),
  "ÃÎÇ½¸¡ºº" => array('¥ì¡¼¥Ö¥ó¿§ºÌ','¥³¡¼¥¹Î©ÊýÂÎ','MMSE','HDS-R','WAIS-R'),
  "È¾ÌÕ¸¡ºº" => array('ÀþÊ¬2ÅùÊ¬','BIT'),
  "Ãí°Õ¸¡ºº" => array('TMT-A','TMT-B','¤«¤Ê½¦¤¤¡ÊÍ­°ÕÌ£¡Ë','¤«¤Ê½¦¤¤¡ÊÌµ°ÕÌ£¡Ë'),
  "µ­²±¸¡ºº" => array('»°Âð¼°µ­ÌÃÎÏ¸¡ºº','¥Ù¥ó¥È¥ó»ë³Ðµ­ÌÃ¸¡ºº','ReyÊ£»¨¿Þ·Á',
		     '¥ê¥Ð¡¼¥ß¡¼¥É¹ÔÆ°µ­²±¸¡ºº','¥¦¥§¥¯¥¹¥é¡¼µ­²±¸¡ºº'),
  "¼º¹Ô¡¦¼ºÇ§" => array('É¸½à¹â¼¡Æ°ºîÀ­¸¡ºº','¹â¼¡»ëÃÎ³Ð¸¡ºº'),
  "Á°Æ¬ÍÕµ¡Ç½" => array('Wisconsin¡¡Card¡¡Sorting¡¡Test','Word¡¡Fluency¡¡Test',
		       'BADS','¥Ï¥Î¥¤¤ÎÅã'),
  "Ä°ÎÏ¸¡ºº" => array('½ã²»Ä°ÎÏ¸¡ºº','¸ì²»Ä°ÎÏ¸¡ºº'),
  "·ÛÉô" => array('·ÛÉô'),
  "¹øÉô" => array('¹øÉô'),
  "·ÛÉô¶¯ÅÙ" => array('-','4¡Á6Kg','6¡Á8Kg','8¡Á10Kg','10¡Á12Kg','12¡Á14Kg',
		     '15¡Á20Kg','20¡Á25Kg','25¡Á30Kg','30¡Á40Kg'),
  "¹øÉô¶¯ÅÙ" => array('-','4¡Á6Kg','6¡Á8Kg','8¡Á10Kg','10¡Á12Kg','12¡Á14Kg',
		     '15¡Á20Kg','20¡Á25Kg','25¡Á30Kg','30¡Á40Kg')
  );

function print_checkb($key,$def) {
  global $rehab_pd;

  foreach ($rehab_pd[$key] as $val) {
    if (ereg("PT$",$val) || ereg("OT$",$val) || ereg("ST$",$val))
      $dispval = substr($val,-2);
    else
      $dispval =$val;
    $str = $str . sprintf('<input type="checkbox" name="i%s" %s>%s<br>',
			  $val,($def[$val] == "on" ? "checked" : ""),$dispval);
  }
  return $str;
}

function print_select_com($key,$def,$size,$com,$unit) {
  global $__mx_formi_dek;
  global $rehab_pd;

  $str = sprintf("<select %s name=\"i%s\">\n",$__mx_formi_dek,$key);
  foreach ($rehab_pd[$key] as $val) {
    $str = $str . sprintf("<option %s value=\"%s\">%s\n",
	   ($val == $def[$key] ? "selected" : ""),$val,$val);
  }
  $str = $str . "</select>\n";
  if ($unit) $str = $str . "&nbsp{$unit}&nbsp;";
  if ($com)
    $str = $str . sprintf('%s<input type="text" name="i%s%s" %s size="%d" maxlength="%d" value="%s">'
	   ,$com,$key,$com,$__mx_formi_dek,intval($size*1.6),$size,$def[$key.$com]);
  return $str;
}

function get_rehab($pid,$oid) {
  $con = mx_db_connect();
  $str = 'select * from "¥ê¥Ï½èÊýäµ"
          where ';
  if ($oid) $str = $str . ' "ObjectID" = ' . "'$oid'";
  else $str = ($str . '"Superseded" IS NULL and "´µ¼Ô" = '.
	       "'$pid'". ' order by "ObjectID"');
  if ($oid)
    return pg_fetch_assoc(pg_query($con,$str));
  else
    return pg_fetch_all(pg_query($con,$str));
}

$check_keys = array('½èÊýÆü','ÂÎ²¹','ÂÎ²¹¼«Í³µ­ºÜ','¼ý½Ì´ü·ì°µ','³ÈÄ¥´ü·ì°µ','SPO2',
		    'SPO2¼«Í³µ­ºÜ','Í­»ÀÁÇ±¿Æ°Êâ¹ÔTime','Í­»ÀÁÇ±¿Æ°Êâ¹ÔTime¼«Í³µ­ºÜ',
		    'Í­»ÀÁÇ±¿Æ°¼Ö°Ø»Ò¶îÆ°Time','Í­»ÀÁÇ±¿Æ°¼Ö°Ø»Ò¶îÆ°Time¼«Í³µ­ºÜ',
		    'Í­»ÀÁÇ±¿Æ°µ¯µïÆ°ºîTime','Í­»ÀÁÇ±¿Æ°µ¯µïÆ°ºîTime¼«Í³µ­ºÜ',
		    'Í­»ÀÁÇ±¿Æ°ºÂ°Ì¤Ç¤ÎÁ´¿È±¿Æ°Time','Í­»ÀÁÇ±¿Æ°ºÂ°Ì¤Ç¤ÎÁ´¿È±¿Æ°Time¼«Í³µ­ºÜ',
		    'Í­»ÀÁÇ±¿Æ°¾õ¶·¤Ë±þ¤¸¤ÆTime','Í­»ÀÁÇ±¿Æ°¾õ¶·¤Ë±þ¤¸¤ÆTime¼«Í³µ­ºÜ',
		    'Í­»ÀÁÇ±¿Æ°Time','Í­»ÀÁÇ±¿Æ°¿´Çï¿ô','Í­»ÀÁÇ±¿Æ°¿´Çï¿ôMAX',
		    '¥Á¥ë¥È¥Æ¡¼¥Ö¥ë','¥Á¥ë¥È¥Æ¡¼¥Ö¥ëTime','¥Á¥ë¥È¥Æ¡¼¥Ö¥ëSet',
		    '¥Ù¥Ã¥É¥®¥ã¥Ã¥¸','¥Ù¥Ã¥É¥®¥ã¥Ã¥¸¼«Í³µ­ºÜ',
		    '¥Ù¥Ã¥É¥®¥ã¥Ã¥¸Time','¥Ù¥Ã¥É¥®¥ã¥Ã¥¸Time¼«Í³µ­ºÜ',
		    '¥Ù¥Ã¥É¥®¥ã¥Ã¥¸Set','¥Ù¥Ã¥É¥®¥ã¥Ã¥¸Set¼«Í³µ­ºÜ',
		    '¥Ù¥Ã¥É¥®¥ã¥Ã¥¸¿´Çï¿ô','¥Ù¥Ã¥É¥®¥ã¥Ã¥¸¿´Çï¿ôMAX','SPO2MAX','VF»Ü¹ÔÆü');

function insert_rehab_order ($var) {
  global $check_keys;

  foreach ($var as $key => $val)
    if (ereg("^i.*",$key)) { 
     $key = substr($key,1);
      if (check_key($key,$check_keys)) {
        if ($key == "½èÊýÆü" || $key == "VF»Ü¹ÔÆü") {
	  $val = mb_convert_kana($val,'a','EUC-JP');
	  $val = mx_ui_japanese_date($val);
	  if (check_date($key,$val)) return;
	}
	$ins[$key] = mb_convert_kana($val,'a','EUC-JP');
      }
      else $ins[$key]=$val;
    }
  $ins['CreatedBy'] = $var['u'];
  $str = make_insert_str("¥ê¥Ï½èÊýäµ",$ins,$oid);

  $ret = true;
  $con = mx_db_connect();
  pg_query($con,"begin");
  pg_query($con,$str) or $ret = false;
  pg_query($con, "commit;");

  return $ret;
}

function update_rehab_order ($var) {
  global $check_keys;

  foreach($var as $key => $val)
    if (ereg("^i.*",$key)) {
      $key = substr($key,1);
      if (check_key($key,$check_keys)) {
        if ($key == "½èÊýÆü" || $key == "VF»Ü¹ÔÆü") {
	  $val = mb_convert_kana($val,'a','EUC-JP');
	  $val = mx_ui_japanese_date($val);
	  if (check_date($key,$val)) return;
	}
	$array[$key] = mb_convert_kana($val,'a','EUC-JP');
      }
      else $array[$key]=$val;
    }
  $array['CreatedBy'] = $var['u'];
  $array['act'] = $var['oid'];

  $ret = true;
  if (diff_contents("¥ê¥Ï½èÊýäµ",$array)) {
    make_update_str("¥ê¥Ï½èÊýäµ",$array,$upstr,$insstr);
    $con = mx_db_connect();
    pg_query($con,"begin");
    pg_query($con,$insstr) or $ret = false;
    pg_query($con,$upstr) or $ret = false;
    pg_query($con, "commit;");
  }
  return $ret;
}

function print_detail($ord) {

  function _p($o,$k,$ext) {
    if ($o[$k] == '-') $o[$k] = "";
    if ($ext)
      return $o[$k]."&nbsp;".$o[$k.$ext];
    else
      return $o[$k];
  }

  function _pc($k,$o) {
    global $rehab_pd;
    foreach ($rehab_pd[$k] as $v) {
      if ($o[$v] == "on") 
	if (ereg("PT$",$v) || ereg("OT$",$v) || ereg("ST$",$v))
	  $str = $str.substr($v,-2)."&nbsp;»ØÄê<br>";
	else
	  $str = $str.$v."&nbsp;»ØÄê<br>";
    }
    return $str;
  }

  print "<th>½èÊýÆü<td>{$ord['½èÊýÆü']}
      <tr><th>¥ê¥Ï½èÊý<td>"._pc('¥ê¥Ï½èÊý',$ord)."
          <th>½èÊý¶èÊ¬<td colspan=3>{$ord['½èÊý¶èÊ¬']}
      <tr><th>Ãæ»ßÍýÍ³<td>"._pc('Ãæ»ßÍýÍ³',$ord)."
          <th>¥³¥á¥ó¥È<td>{$ord['Ãæ»ßÍýÍ³¥³¥á¥ó¥È']}
      <tr><th colspan=4>µ¡Ç½¾ã³²
      <tr><th>°Õ¼±¾ã³²<td colspan=3>"._p($ord,'°Õ¼±¾ã³²','¥³¥á¥ó¥È')."
      <tr><th>JCS<td colspan=3>{$ord['JCS']}<td><td>
      <tr><th>¸«Åö¼±¾ã³²<td>"._p($ord,'ÃÔÊò','¥³¥á¥ó¥È')."
         <th>ÃÎÅª¾ã³²<td>"._p($ord,'ÃÎÅª¾ã³²','¥³¥á¥ó¥È')."
      <tr><th colspan=4>¹â¼¡µ¡Ç½¾ã³²
      <tr><th>Ãí°ÕÎÏ¾ã³²<td>"._P($ord,'Ãí°Õ¾ã³²','¥³¥á¥ó¥È')."
          <th>µ­ÌÃÎÏ¾ã³²<td>"._p($ord,'µ­²±¾ã³²','¥³¥á¥ó¥È')."
      <tr><th>¼ºÇ§<td>"._p($ord,'¼ºÇ§','¥³¥á¥ó¥È')."
          <th>¼º¹Ô<td>"._p($ord,'¼º¹Ô','¥³¥á¥ó¥È')."
      <tr><th>¼º¸ì<td>"._p($ord,'¼º¸ì','¥³¥á¥ó¥È')."
          <th nowrap>È¾Â¦»ë¶õ´ÖÌµ»ë<td nowrap>".
    _p($ord,'È¾Â¦»ë¶õ´ÖÌµ»ë','¥³¥á¥ó¥È')."
      <tr><th colspan=4>ÃÎ³Ð¾ã³²
      <tr><th nowrap>»ë³Ð¾ã³²<td nowrap>"._p($ord,'»ë³Ð¾ã³²','¥³¥á¥ó¥È')."
          <th>Ä°³Ð¾ã³²<td>"._p($ord,'Ä°³Ð¾ã³²','¥³¥á¥ó¥È')."
      <tr><th>É½ºß´¶³Ð¾ã³²<td>"._p($ord,'É½ºß´¶³Ð¾ã³²','¥³¥á¥ó¥È')."
          <th>¿¼Éô´¶³Ð¾ã³²<td>"._p($ord,'¿¼Éô´¶³Ð¾ã³²','¥³¥á¥ó¥È')."
      <tr><th>ÄË¤ß<td>"._p($ord,'ÄË¤ß','¥³¥á¥ó¥È')."
          <th>¹½²»¾ã³²<td>"._p($ord,"¹½²»¾ã³²",'¥³¥á¥ó¥È').
     '<tr><th>¸ÆµÛ¡¦½Û´Ä´ï¾ã³²<br>¡Êµ¯Î©À­Äã·ì°µ¡¦Ëö¾¿½Û´Ä¾ã³²¡Ë<td>'.
               _p($ord,"¸ÆµÛ½Û´Ä´ïµ¡Ç½¾ã³²",'¥³¥á¥ó¥È').
          '<th>ÀÝ¿©µ¡Ç½¾ã³²<td>'._p($ord,"ÀÝ¿©µ¡Ç½¾ã³²",'¥³¥á¥ó¥È').
      '<td><td><tr><th colspan="4">ÇÓÝõµ¡Ç½¾ã³²
       <tr><th>ÇÓÇ¢µ¡Ç½¾ã³²<td>'._p($ord,"ÇÓÇ¢µ¡Ç½¾ã³²",'¥³¥á¥ó¥È').
           '<th>ÇÓÊØµ¡Ç½¾ã³²<td>'._p($ord,"ÇÓÊØµ¡Ç½¾ã³²",'¥³¥á¥ó¥È').
      '<tr><th>Ãæ¿õÀ­Ëãáã<td>'._p($ord,"Ãæ¿õÀ­Ëãáã",'¥³¥á¥ó¥È').
          '<th>¹´½Ì<td>'._p($ord,"¹´½Ì",'¥³¥á¥ó¥È').
      '<tr><th>¶ÚÎÏÄã²¼<td>'._p($ord,"¶ÚÎÏÄã²¼",'¥³¥á¥ó¥È').
      '<tr><th colspan="4">¶Ú¶ÛÄ¥¤Î¾ã³²
       <tr><th>ÃÐ´Ë<td>'._p($ord,"ÃÐ´Ë",'¥³¥á¥ó¥È').
          '<th>áÛÀ­<td>'._p($ord,"áÛÀ­",'¥³¥á¥ó¥È').
      '<tr><th>¸Ç½Ì<td>'._p($ord,"¸Ç½Ì",'¥³¥á¥ó¥È').
          '<th>ÉÔ¿ï°Õ±¿Æ°<br>¡Ê¼ºÄ´¡¦¿¶Àï¡Ë<td>'._p($ord,"ÉÔ¿ï°Õ±¿Æ°",'¥³¥á¥ó¥È').
      '<tr><th>êóÁÏ<td>'._p($ord,"êóÁÏ",'¥³¥á¥ó¥È').
          "<th>µ¡Ç½¾ã³²¥³¥á¥ó¥È<td>{$ord['µ¡Ç½¾ã³²¥³¥á¥ó¥È']}
       <tr><th>·±Îý·ÁÂÖ<td>{$ord['·±Îý·ÁÂÖ']}
       <tr><th>±¿Æ°»þ¥â¥Ë¥¿¡¼<td>"._pc("±¿Æ°»þ¥â¥Ë¥¿¡¼É¬Í×",$ord).
          "<th>¥â¥Ë¥¿¥Ë¥ó¥°¤ÎÆâÍÆ
           <td>{$ord['¥â¥Ë¥¿¥Ë¥ó¥°¤ÎÆâÍÆ']}
       <tr><th nowrap colspan=4>·±ÎýÃæ»ß´ð½à&nbsp;
           85ºÐ°Ê¾å¤Î¾ì¹ç¤Ï¡¢¿´Çï¿ô¤Î¾å¸Â¤ò¤Ä¤±¤ë¡Ê0.9(220¡¡-¡¡Ç¯Îð)¡Ë
       <tr><th>°Õ¼±¥ì¥Ù¥ëÄã²¼<td>"._pc("°Õ¼±¥ì¥Ù¥ëÄã²¼",$ord).
          '<th>¤±¤¤¤ì¤ó¤Î½ÅÀÕ<td>'._pc("¤±¤¤¤ì¤ó¤Î½ÅÀÕ",$ord).
      "<tr><th>ÂÎ²¹<td>{$ord['ÂÎ²¹']}&nbsp;{$ord['ÂÎ²¹¼«Í³µ­ºÜ']}¡î°Ê¾å
       <tr><th>¼ý½Ì´ü·ì°µ
           <td>{$ord['¼ý½Ì´ü·ì°µ']}£í£í£È£ç°Ê¾å
           <th>³ÈÄ¥´ü·ì°µ
           <td>{$ord['³ÈÄ¥´ü·ì°µ']}£í£í£È£ç°Ê¾å
       <tr><th>SPO2%<td>{$ord['SPO2']}&nbsp;{$ord['SPO2¼«Í³µ­ºÜ']}¡ó°Ê²¼
           <th>Anderson¤Î´ð½à<td>"._p($ord,"Anderson¤Î´ð½à",'¥³¥á¥ó¥È').
      '<tr><th colspan="4">´µ¼Ô¥Ë¡¼¥º¡Ê¥ê¥ÏÅª¡Ë<br>ÌÜÉ¸¡Ê·±ÎýÌÜÉ¸¡Ë
       <tr><th>´ðËÜÆ°ºîÇ½ÎÏ<th>'._p($ord,"´ðËÜÆ°ºîÇ½ÎÏ",false).
          '<th>Ž¾ŽÙŽÌŽ¹Ž±Ç½ÎÏ<th>'._p($ord,"Ž¾ŽÙŽÌŽ¹Ž±Ç½ÎÏ",false).
      '<tr><th>Ç§ÃÎÇ½ÎÏ<th>'._p($ord,"Ç§ÃÎÇ½ÎÏ",false).
          "<th>¥³¥á¥ó¥È<td>{$ord['ÌÜÉ¸¥³¥á¥ó¥È']}
       <tr><th colspan=4>ÆâÍÆ
       <tr><th>´ØÀá²ÄÆ°°è·±Îý<td>"._pc("´ØÀá²ÄÆ°°è·±Îý",$ord).
          '<th>¶ÚÎÏÁý¶¯·±Îý<td>'._pc("¶ÚÎÏÁý¶¯·±Îý",$ord).
      '<tr><th>¿À·Ð¶ÚºÆ¶µ°é<td>'._pc("¿À·Ð¶ÚºÆ¶µ°é",$ord).
          '<th>¶¨Ä´À­·±Îý<td>'._pc("¶¨Ä´À­·±Îý",$ord).
      '<tr><th>Á´¿ÈÄ´À°·±Îý<td colspan="3">'._pc("Á´¿ÈÄ´À°·±Îý",$ord).'<p>Í­»ÀÁÇ±¿Æ°<br>';
    foreach (array('Êâ¹Ô','¼Ö°Ø»Ò¶îÆ°','µ¯µïÆ°ºî','ºÂ°Ì¤Ç¤ÎÁ´¿È±¿Æ°','¾õ¶·¤Ë±þ¤¸¤Æ') as $item) {
      $time = 'Í­»ÀÁÇ±¿Æ°'.$item.'Time';
      $com = $time.'¼«Í³µ­ºÜ';
      print "{$item}¤ò{$ord[$time]}&nbsp{$ord[$com]}Ê¬´Ö<br>\n";
    }
    print "¤Þ¤¿¤Ï¡¢{$ord['Í­»ÀÁÇ±¿Æ°']}¤ò{$ord['Í­»ÀÁÇ±¿Æ°Time']}Ê¬´Ö<p>
           ÌÜÉ¸¿´Çï¿ô{$ord['Í­»ÀÁÇ±¿Æ°¿´Çï¿ô']}b¡¿Ê¬ Max HR
           {$ord['Í­»ÀÁÇ±¿Æ°¿´Çï¿ôMAX']}%ÉÕ¶á<p>
           ¥Á¥ë¥È¥Æ¡¼¥Ö¥ë<br>
           {$ord['¥Á¥ë¥È¥Æ¡¼¥Ö¥ë']}&deg;
           {$ord['¥Á¥ë¥È¥Æ¡¼¥Ö¥ëTime']}Ê¬´Ö X
           {$ord['¥Á¥ë¥È¥Æ¡¼¥Ö¥ëSet']}¥»¥Ã¥È<p>
           ¥Ù¥Ã¥É¥®¥ã¥Ã¥¸<br>".
           _p($ord,"¥Ù¥Ã¥É¥®¥ã¥Ã¥¸",false)."&deg;".
           _p($ord,"¥Ù¥Ã¥É¥®¥ã¥Ã¥¸Time",false).'Ê¬´Ö X'.
           _p($ord,"¥Ù¥Ã¥É¥®¥ã¥Ã¥¸Set",false)."¥»¥Ã¥È<br>¤Þ¤¿¤Ï¡¢
           {$ord['¥Ù¥Ã¥É¥®¥ã¥Ã¥¸¼«Í³µ­ºÜ']}&deg;
           {$ord['¥Ù¥Ã¥É¥®¥ã¥Ã¥¸Time¼«Í³µ­ºÜ']}Ê¬´Ö X
           {$ord['¥Ù¥Ã¥É¥®¥ã¥Ã¥¸Set¼«Í³µ­ºÜ']}¥»¥Ã¥È<p>
           <p>ÌÜÉ¸¿´Çï¿ô{$ord['¥Ù¥Ã¥É¥®¥ã¥Ã¥¸¿´Çï¿ô']}b¡¿Ê¬ Max HR
           {$ord['¥Ù¥Ã¥É¥®¥ã¥Ã¥¸¿´Çï¿ôMAX']}%ÉÕ¶á<p>
           SPO2 {$ord['SPO2MAX']}¡ó°Ê²¼¤Î²¼¹ß¤ÇµÙ·Æ¤ò¤È¤ë¡£
       <tr><th>¹ªåÌÆ°ºî·±Îý<td>"._pc("¹ªåÌÆ°ºî·±Îý",$ord).
          '<th>´ðËÜÆ°ºî·±Îý<td>'._pc("´ðËÜÆ°ºî·±Îý",$ord).
      '<tr><th>Æü¾ïÀ¸³è³èÆ°·±Îý<td>'._pc("Æü¾ïÀ¸³è³èÆ°·±Îý",$ord).
          '<th>Æü¾ï´ØÏ¢Æ°ºî·±Îý<td>'._pc("Æü¾ï´ØÏ¢Æ°ºî·±Îý",$ord).
      '<tr><th>Ç§ÃÎ·±Îý<td>'._pc("Ç§ÃÎ·±Îý",$ord).
          '<th>ÉÂÅï´Ä¶­ÀßÄê<td>'._pc("ÉÂÅï´Ä¶­ÀßÄê",$ord).
      '<tr><th>ÊäÁõ¶ñ¡¦¼«½õ¶ñ¤Î¸¡Æ¤<td>'._pc("ÊäÁõ¶ñ¡¦¼«½õ¶ñ¤Î¸¡Æ¤",$ord).
          "<th>ÊäÁõ¶ñ¼ïÎà
           <td>{$ord['ÊäÁõ¶ñ¼ïÎà']}
       <tr><th>ºßÂðÉ¾²Á¡¦·±Îý<td>"._pc("ºßÂðÉ¾²Á¡¦·±Îý",$ord).
          '<th>»ýµ×ÎÏÉ¾²Á<td>'._pc("»ýµ×ÎÏÉ¾²Á",$ord).
      '<tr><th>¤½¤ÎÂ¾ÆÃÄê¤ÎÉ¾²Á°ÍÍê<td>'._pc("¤½¤ÎÂ¾ÆÃÄê¤ÎÉ¾²Á°ÍÍê",$ord).
          "<th>É¾²ÁÆâÍÆ
           <td>{$ord['É¾²ÁÆâÍÆ']}
       <tr><th>¼º¸ì¾É·±Îý<td>"._pc("¼º¸ì¾É·±Îý",$ord).
          "<th>¥³¥á¥ó¥È<td>{$ord['¼º¸ì¾É·±Îý¥³¥á¥ó¥È']}";
    if ($ord['¼º¸ì¾É·±ÎýÉ¾²Á'])
      print '
       <tr><th colspan="4">¼º¸ì¾É¸¡ºº
       <tr><th>Áí¹çÅª¸¡ºº<td>'._pc("Áí¹çÅª¸¡ºº",$ord).
          '<th>·¡¤ê²¼¤²¸¡ºº<br>Ä°¤¯²áÄø<td>'._pc("Ä°¤¯²áÄø",$ord).
      '<tr><th>ÏÃ¤¹²áÄø<td>'._pc("ÏÃ¤¹²áÄø",$ord).
	  '<th>ÆÉ¤ß½ñ¤­²áÄø<td>'._pc("ÆÉ¤ß½ñ¤­²áÄø",$ord).
      '<tr><th>¹½Ê¸Ç½ÎÏ<td>'._pc("¹½Ê¸Ç½ÎÏ",$ord).
	  '<th>¼ÂÍÑÅª¤ÊŽºŽÐŽ­ŽÆŽ¹Ž°Ž¼Ž®ŽÝ¤Ë´Ø¤¹¤ë¸¡ºº<td>'._pc("CADL",$ord).
      '<tr><th>Á´¼º¸ì¡Á½ÅÅÙ¼º¸ì¤¬µ¿¤ï¤ì¤ë¾ì¹ç<td>'._pc("½ÅÅÙ¼º¸ì¾É¸¡ºº",$ord).
	  "<th>¥³¥á¥ó¥È<td>{$ord['¼º¸ì¾É¸¡ºº¥³¥á¥ó¥È']}";

    print '<tr><th>¹½²»·±Îý
           <td>'._pc("¹½²»·±Îý",$ord).
          "<th>¥³¥á¥ó¥È<td>{$ord['¹½²»·±Îý¥³¥á¥ó¥È']}";

    if ($ord['¹½²»·±ÎýÉ¾²Á'])
      print '
       <tr><th colspan="4">¹½²»¸¡ºº
       <tr><th>¸¡ººÆâÍÆ<td>'._pc("¹½²»¸¡ºº",$ord).
          "<th>¥³¥á¥ó¥È<td>{$ord['¹½²»¸¡ºº¥³¥á¥ó¥È']}";

    print '<tr><th>¹â¼¡Ç¾µ¡Ç½·±Îý<td>'._pc("¹â¼¡Ç¾µ¡Ç½·±Îý",$ord).
          "<th>¥³¥á¥ó¥È<td>{$ord['¹â¼¡Ç¾µ¡Ç½·±Îý¥³¥á¥ó¥È']}";
    if ($ord['¹â¼¡Ç¾µ¡Ç½·±ÎýÉ¾²Á'])
      print '
       <tr><th colspan="4">¹â¼¡Ç¾µ¡Ç½É¾²Á
       <tr><th>ÃÎÇ½¸¡ºº<td>'._pc("ÃÎÇ½¸¡ºº",$ord).
          '<th>È¾Â¦¶õ´ÖÌµ»ë¡¦È¾ÌÕ¸¡ºº<td>'._pc("È¾ÌÕ¸¡ºº",$ord).
      '<tr><th>Ãí°Õ¸¡ºº<td>'._pc("Ãí°Õ¸¡ºº",$ord).
          '<th>µ­²±¸¡ºº<td>'._pc("µ­²±¸¡ºº",$ord).
      '<tr><th>¼º¹Ô¡¦¼ºÇ§<td>'._pc("¼º¹Ô¡¦¼ºÇ§",$ord).
          '<th>Á°Æ¬ÍÕµ¡Ç½<td>'._pc("Á°Æ¬ÍÕµ¡Ç½",$ord).
      "<tr><th>¥³¥á¥ó¥È
           <td>{$ord['¹â¼¡Ç¾µ¡Ç½É¾²Á¥³¥á¥ó¥È']}";

    print '<tr><th>ÀÝ¿©Óë²¼·±Îý<td>'._pc("ÀÝ¿©Óë²¼·±Îý",$ord).
          "<th>¥³¥á¥ó¥È
           <td>{$ord['ÀÝ¿©Óë²¼·±Îý¥³¥á¥ó¥È']}
       <tr><th>VF»Ü¹ÔÆü
           <td>{$ord['VF»Ü¹ÔÆü']}
           <th>VFÌÜÅª
           <td>{$ord['VFÌÜÅª']}
       <tr><th>Ä°³ÐÉ¾²Á
           <td>{$ord['Ä°³ÐÉ¾²Á']}";


    if ($ord['Ä°³ÐÉ¾²Á'])
      print "
           <th>Ä°³ÐÉ¾²Á¥³¥á¥ó¥È
           <td>{$ord['Ä°³ÐÉ¾²Á¥³¥á¥ó¥È']}
       <tr><th colspan=4>Ä°ÎÏ¸¡ºº
       <tr><th>¸¡ººÆâÍÆ<td>"._pc("Ä°ÎÏ¸¡ºº",$ord).
	  "<th>¥³¥á¥ó¥È
           <td>{$ord['Ä°ÎÏ¸¡ºº¥³¥á¥ó¥È']}";

    print '<tr><th colspan="4">ÊªÍýÎÅË¡';
    foreach(array('¥Û¥Ã¥È¥Ñ¥Ã¥¯','¥Þ¥¤¥¯¥í¥¦¥¨¡¼¥Ö','Ä¶²»ÇÈË¡ÎÅ','Äã¼þÇÈË¡ÎÅ',
                  '²áÎ®Íá','¥¢¥¤¥¹¥Ñ¥Ã¥¯','¥Ï¥É¥Þ¡¼','¸£°ú')
	    as $item) {
      if (!($c++ % 2)) print "<tr>";
      $place = $item."Éô°Ì";
      print "<td>{$item} 
             <td>Éô°Ì&nbsp;{$ord[$place]}";
    }
    print '<tr><th colsapn="4">Éô°Ì
           <tr><td>'._pc("·ÛÉô",$ord).'<td>'.
      _p($ord,"·ÛÉô¶¯ÅÙ",false).
              '<td>'._pc("¹øÉô",$ord).'<td>'.
      _p($ord,"¹øÉô¶¯ÅÙ",false).
   "<tr><th>¤½¤ÎÂ¾ÆÃµ­»ö¹à<td colspan=3>{$ord['¤½¤ÎÂ¾ÆÃµ­»ö¹à']}";
}
?>