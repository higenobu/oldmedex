<?php
include_once $_SERVER['DOCUMENT_ROOT'].'/lib/common.php';
include_once $_SERVER['DOCUMENT_ROOT'].'/lib/u/manage/calend.php';
include_once $_SERVER['DOCUMENT_ROOT'].'/lib/u/everybody/ps-anew.php';
include_once $_SERVER['DOCUMENT_ROOT'].'/lib/ppa.php';

$__lib_u_manage_floor_ed_floors = array();
$__floor_config = $_SERVER['DOCUMENT_ROOT']."/lib/u/manage/floor";
//include_once "$__floor_config/$_mx_hospital_floor/floors.php";
include_once $_SERVER['DOCUMENT_ROOT'].'/lib/u/manage/floor/krh/floors.php';
$u = mx_authenticate_user();
$auth = mx_authorization();
if (! $auth[0]) {
  mx_authorization_error($auth);
  return;
}

$__lib_u_manage_floor_ed_coloring_button_breaks = array("£Æ£É£ÍÁí¹ç" => 1);
$__lib_u_manage_floor_ed_coloring_ix_to_label =
array(
      'À­ÊÌ',
     '²óÉü',
     'ºß±¡Æü¿ô',
     '°å³ØÅªÉÔ°ÂÄê',
   '´¶À÷¾É',
      '£Æ£É£ÍÁí¹ç',
      '£Æ£É£Í°ÜÆ°',
     '£Æ£É£Í¥È¥¤¥ì',
      '£Æ£É£ÍÍý²ò',
      );
$__lib_u_manage_floor_ed_coloring_label_to_ix = array();

function __lib_u_manage_floor_ed_coloring_setup() {
	global $__lib_u_manage_floor_ed_coloring_ix_to_label;
	global $__lib_u_manage_floor_ed_coloring_label_to_ix;
	foreach ($__lib_u_manage_floor_ed_coloring_ix_to_label
		 as $ix => $label) {
		$__lib_u_manage_floor_ed_coloring_label_to_ix[$label] = $ix;
	}
}
__lib_u_manage_floor_ed_coloring_setup();

class floor_ed_calendar extends simple_clickable_month_calendar_display {
	function floor_ed_calendar($prefix) {
		$config = array('ShowHide' => 0);
		simple_clickable_month_calendar_display::simple_clickable_month_calendar_display($prefix, $config);
		$this->showing = 1;
	}

	function draw_day($year, $month, $mday) {
		$ymd = $this->chosen();
		$mday_show = $mday;
		if ($ymd &&
		    $ymd[0] == $year && $ymd[1] == $month &&
		    $ymd[2] == $mday) {
			print "<span class=\"title\">$mday</span>";
			return;
		}
		simple_clickable_month_calendar_display::draw_day($year, $month, $mday);
	}
}

/* This is a callback from the HTML template to embed HTML representation
 * for each slot (i.e. the "o()" function).
 */
function draw_floor_element($thing) {
	global $__this_output_data, $__calendar;

	if ($thing == 'calendar') {
		$__calendar->draw();
	}
	else if ($thing == 'legend') {
		$l = $__this_output_data['legend'];
		$s = $__this_output_data['legend-stat'];
		if (!(is_array($l) && count($l)))
			return;

		$w = array();
		foreach ($s as $ward => $data) {
			if ($ward != '')
				$w[$ward] = $data;
		}
		ksort($w);
		$w['ÂàÈò'] = $s[''];

		/*
		 * $w[$wardname] => $data (wardname includes "wait" and "sum")
		 * $data[$cclass] => $number (cclass are 'red', 'blue',...)
		 * $l[$cclass] => $wardname
		 */
		print '<table class="legend"><tr><td>(ËÞÎã)</td>';
		foreach ($w as $ward => $data) {
			print '<td>';
			print htmlspecialchars($ward);
			print '</td>';
		}
		print "<td>¹ç·×</td></tr>\n";

		/*
		 * $sums[$ward] => $number
		 */
		$sums = array();
		foreach ($l as $cclass => $txt) {
			print "<tr class=\"$cclass\">";
			print "<td>";
			print htmlspecialchars($txt);
			print "</td>\n";
			$sum = 0;
			foreach ($w as $ward => $data) {
				print '<td>';
				$cnt = $w[$ward][$cclass] + 0;
				print $cnt;
				print '</td>';
				$sum += $cnt;
				$sums[$ward] += $cnt;
			}
			print "<td>$sum</td>";
			print "</tr>\n";
		}

		print "<tr>";
		print "<td>¹ç·×</td>\n";
		$sum = 0;
		foreach ($w as $ward => $data) {
			print '<td>';
			$cnt = $sums[$ward] + 0;
			print $cnt;
			print '</td>';
			$sum += $cnt;
		}
		print "<td>$sum</td>";
		print "</tr>\n";
		
		print "</table>\n";
	}
	else if ($thing == 'soon') {
		$l = $__this_output_data['soon-discharge'];
//0723-2012
$l=null;
//

		if (!(is_array($l) && count($l)))
			return;
		asort($l);
		print '<table class="soon"><tr><td class="caption">';
		print '</td></tr>';
		foreach ($l as $junk) {
			print "<tr><td class=\"data\">$junk</td></tr>";
		}
		print "</tr></table>\n";
	}
	else {
		$d = $__this_output_data[$thing];
		if ($d == '') {
			print '&nbsp;';
		}
		else {
			print $d;
		}
	}
}

function floor_ed_fill_in_fim_diff($d) {
	$nv = $d[0];
	$ov = $d[1];
	if ($ov)
		return htmlspecialchars("$nv (Á°²ó $ov)");
	else
		return htmlspecialchars("$nv");
}

function draw_header($opts, $data, $output_data) {
	global $__lib_u_manage_floor_ed_coloring_ix_to_label;
	global $_mx_resource_dir;
	$ix_to_label = $__lib_u_manage_floor_ed_coloring_ix_to_label;

	$floor = $opts['floor'];

?><html>
<head>
<meta http-equiv="content-type" content="text/html; charset=euc-jp">
<link rel="stylesheet"
 href="/<? print $_mx_resource_dir ?>/mxstyle.css" />
<script language="JavaScript"
 src="/<? print $_mx_resource_dir ?>/mx.js"></script>
<script language="JavaScript"
 src="/<? print $_mx_resource_dir ?>/infobox.js"></script>
<style type="text/css">
 td.bedcell {
     background-color: #ccc;
     text-align: center;
     vertical-align: center;
 }
 td.wait {
     background-color: #ccc;
     text-align: left;
     vertical-align: top;
     padding-top: 8px;
 }
 td.wait span.padded { padding: 2px; }
 tr.caption {
     height: 24px;
 }
 td.calendar {
     vertical-align: top;
 }
 td.caption { text-align: center; background-color: <?
 print $opts['capcolor'] ?>; }
 table.floor { background-color: <?
 print $opts['floorcolor'] ?>; }
 td.tiptd { background-color: #ffc; }
 td.tiptd * table { width: 100%; }
 td.tiptd * th.ptt { background-color: #282; }
 td.tiptd * td.pst { background-color: #cf8; }
 td.tiptd * th.divider { background-color: #000; color: #fff; }

 a:visited, a:link { color: #000; }
 a:hover { color: #888; }
 a.active { background-color: #fff; }
 a { text-decoration: none; }
 a.pending:before { content: "?" }
 a.pending { text-decoration: underline; }
 a.soon { text-decoration: ; }

 table.legend {
	 border-color: black;
	 border-width: thin;
	 border-style: dashed;
	 padding: 8px;
 }

 table.legend tr.paint-blue td { background-color: #88f; }
 table.legend tr.paint-red td { background-color: #f88; }
 table.legend tr.paint-green td { background-color: #8f8; }
 table.legend tr.paint-yellow td { background-color: #ff8; }
 table.legend tr.paint-pink td { background-color: #faf; }
 table.legend tr td { text-align: right; }

 span.padded { padding: 2px; }
 span.paint-blue { background-color: #88f; }
 span.paint-red { background-color: #f88; }
 span.paint-green { background-color: #8f8; }
 span.paint-yellow { background-color: #ff8; }
 span.paint-pink { background-color: #faf; }

 table.soon { width: 100%; }
 table.soon td.caption:before { content: "Í½Äê" }
 table.soon td.caption { background-color: #fca; }
 table.soon td.data { background-color: #000; color: #ff0; }
</style>

<script language="JavaScript">

// use it like this:
// (a class="active" onclick="pickit('901.1')") Foo (/a)
function pickit(ident) {
	elem = document.getElementById('update')
	elem.value = 'pickit=' + ident
	form = document.getElementById('form')
	form.submit() 
}
function floorit(ident) {
	elem = document.getElementById('floor')
	elem.value = 'pickit=' + ident
	form = document.getElementById('form')
	form.submit() 
}
function colorit(ident) {
	elem = document.getElementById('color')
	elem.value = 'pickit=' + ident
	form = document.getElementById('form')
	form.submit() 
}
</script>
</head>
<body>
<script language="JavaScript">
inittips()
<?php
 $pi = $data['patient-info'];
 $es = $data['empty-schedule'];
 foreach ($pi as $oid => $data) {
	 $slot = $output_data['occupies'][$oid];
	 if (!$slot ||
	     /* This is a hack */
	     (strcmp(substr($slot, 0, 5), "wait.") &&
	      strcmp(substr($slot, 0, 1), $floor)))
		 continue;

	$n = addslashes($data['À«Ì¾']);
	$tt = '';
	foreach (array('´µ¼ÔID', 'À­ÊÌ', 'Íø¤­¼ê', 'À¸Ç¯·îÆü',
		       'È¯¾ÉÆü', 'Æþ±¡Æü',
		       'Âà±¡Í½ÄêÆü') as $c) {
		if (array_key_exists('DD'.$c, $data))
			$da = $data['DD'.$c];
		else
			$da = $data[$c];
		$da = htmlspecialchars($da);
		$tt .= '<tr><td>'.addslashes(htmlspecialchars($c)).'</td>';
		$tt .= '<td>'.addslashes($da);
		$tt .= '</td></tr>';
	}

	$color_label = ((0 <= $opts['coloring']) ?
			$ix_to_label[$opts['coloring']] : NULL);
	switch ($color_label) {
	case 'À­ÊÌ':
	case '°å³ØÅªÉÔ°ÂÄê':
		break; /* nothing to add */

	case '´¶À÷¾É':
		if ($data['´¶À÷¾É'] != '') {
			$da = htmlspecialchars($data['´¶À÷¾É']);
			$tt .= '<tr><td>´¶À÷¾É</td><td>';
			$tt .= addslashes($da);
			$tt .= '</td></tr>';
		}
		break;
	case '£Æ£É£Í°ÜÆ°':
	case '£Æ£É£Í¥È¥¤¥ì':
	case '£Æ£É£ÍÍý²ò':
	case '£Æ£É£ÍÁí¹ç':
		$raw_fim = $data['FIM']['RAW'];
		$fim_head = addslashes("<tr><th class=\"divider\" " .
				       "colspan=\"2\">£Æ£É£Í</th></tr>");
		if ($data['FIM']['PHY'][0] && $data['FIM']['COG'][0]) {
			$t = '<tr><td>±¿Æ°¹àÌÜ¹ç·×</td><td>';
			$t .= floor_ed_fill_in_fim_diff($data['FIM']['PHY']);
			$t .= '</td></tr>';
			$t .= '<tr><td>Ç§ÃÎ¹àÌÜ¹ç·×</td><td>';
			$t .= floor_ed_fill_in_fim_diff($data['FIM']['COG']);
			$t .= '</td></tr>';
			$t .= '<tr><td>£Æ£É£Í¹ç·×</td><td>';
			$t .= floor_ed_fill_in_fim_diff($data['FIM']['SUM']);
			$t .= '</td></tr>';
			$tt .= $fim_head . addslashes($t);
			$fim_head = '';
		}
		foreach ($raw_fim[0] as $col => $val) {
			if ($col == '°ÜÆ°¼êÃÊ')
				continue;
			if (array_key_exists($col, $raw_fim[1])) {
				$oval = $raw_fim[1][$col];
				$da = htmlspecialchars("$val (Á°²ó $oval)");
			}
			else {
				$da = htmlspecialchars("$val");
			}
			$tt .= $fim_head . '<tr><td>'.
				addslashes(htmlspecialchars($col)).
				'</td>';
			$tt .= '<td>'.addslashes($da);
			$tt .= '</td></tr>';
			$fim_head = '';
		}
		break;
	case '²óÉü':
	case 'ºß±¡Æü¿ô':
		$da = htmlspecialchars($data['ºß±¡Æü¿ô'] . ' Æü');
		$tt .= '<tr><td>ºß±¡Æü¿ô</td><td>';
		$tt .= addslashes($da);
		$tt .= '</td></tr>';
		break;
	}
	$s = "<table>$tt</table>";
	print "maketip(\"tip-$oid\", \"$n\", \"$s\")\n";
 }
 foreach ($es as $slot => $data) {
	/* This is a hack */
	if (strcmp(substr($slot, 0, 5), "wait.") &&
	    strcmp(substr($slot, 0, 1), $floor))
		continue;
	$n = $slot;
	$t = '';
	$t .= ('<tr><td>Í½Äê´µ¼ÔÌ¾</td><td>' .
	      htmlspecialchars($data['patient-name']) .
	      '</td></tr>');
	$t .= ('<tr><td>´µ¼ÔID</td><td>' .
	      htmlspecialchars($data['patient-id']) .
	      '</td></tr>');
	$t .= ('<tr><td>¼«</td><td>' .
	      htmlspecialchars($data['begin-full']) .
	      '</td></tr>');
	$t .= ('<tr><td>»ê</td><td>' .
	      htmlspecialchars($data['end-full']) .
	      '</td></tr>');
	$s = "<table>$t</table>";
	print "maketip(\"tip-b-$slot\", \"$n\", \"$s\")\n";
 }
?>
</script>
<form id="form" method="POST">
<?php }

function draw_footer($session, $data) {
	global $__dbg;
	global $__this_output_data;
	print "</form>";
	if (0) {
		print "Session: $session<br />\n";
		print "Debug: $__dbg<br />\n";
		print "<!--\n";
		var_dump($data);
		print "-->\n";
	}
	if (0) {
		print "Debug: $__dbg<br />\n";
		$db = mx_db_connect();
		$stmt = 'SELECT * FROM "ÉÂ¾²´ÉÍý"
ORDER BY "ÀêÍ­¼Ô","ÀêÍ­³«»Ï"';
		print "<table>";
		print "<tr><th>";
		print "ÀêÍ­¼Ô";
		print "</th><th>";
		print "ÉÂ¼¼";
		print "</th><th>";
		print "ÉÂ¾²";
		print "</th><th>";
		print "ÀêÍ­³«»Ï";
		print "</th><th>";
		print "ÀêÍ­½ªÎ»";
		print "</th></tr>";
		foreach (pg_fetch_all(pg_query($db, $stmt)) as $data) {
			print "<tr><td>";
			print htmlspecialchars($data["ÀêÍ­¼Ô"]);
			print "</td><td>";
			print htmlspecialchars($data["ÉÂ¼¼"]);
			print "</td><td>";
			print htmlspecialchars($data["ÉÂ¾²"]);
			print "</td><td>";
			print htmlspecialchars($data["ÀêÍ­³«»Ï"]);
			print "</td><td>";
			print htmlspecialchars($data["ÀêÍ­½ªÎ»"]);
			print "</td></tr>";
		}
		print "</table>";
	}
	print $__this_output_data['schedule'];
	print "</body>\n</html>\n";
}

$__ses_table = "ÉÂ¾²´ÉÍý¥»¥Ã¥·¥ç¥ó";

function floor_ed_mark_stay($data)
{
	$days = $data['ºß±¡Æü¿ô'];
	/* 4mo < red
	 * 3mo < yellow
	 * 2mo < blue
	 * < 2mo no mark
	 */
	if (150 < $days)
		return 'paint-red';
	else if (90 < $days)
		return 'paint-yellow';
	else if (60 < $days)
		return 'paint-blue';
	else
		return 'paint-green';
}

function floor_ed_mark_reha_class($data)
{
	$basis = $data['²óÉü´ü'];
	$days = $data['ºß±¡Æü¿ô'];
	$class = array(
		'A' => 150,
		'B' => 180,
		'C' => 90,
		'D' => 90,
		'E' => 60,
		);
	if (array_key_exists($basis, $class) &&
	    ($days <= $class[$basis]))
		return 'paint-blue';
	else
		return 'paint-red';
}

function floor_ed_mark_fim($data)
{
	if (!$data || !array_key_exists('FIM', $data))
		return;
	$fim = $data['FIM'];
	if (!array_key_exists('SUM', $fim))
		return;
	if (!$fim['SUM'][0] || !$fim['SUM'][1])
		return NULL;
	$improvement = $fim['SUM'][0] - $fim['SUM'][1];
	if (5 < $improvement)
		return 'paint-blue';
	else if (3 <= $improvement)
		return 'paint-green';
	else if (-3 < $improvement)
		return 'paint-yellow';
	else if (-5 < $improvement)
		return 'paint-pink';
	else
		return 'paint-red';
}

function floor_ed_mark_fim_mobil($data)
{
	if (!$data ||
	    !array_key_exists('°ÜÆ°¼êÃÊ', $data['FIM']['RAW'][0]))
		return;
	$fim = $data['FIM']['RAW'][0];
	$wheelchair = ($fim['°ÜÆ°¼êÃÊ'] == 'W');
	if (!$wheelchair && 3 < $fim['Êâ¹Ô'])
		return 'paint-blue';
	if (5 <= $fim['¼Ö°Ø»Ò'])
		return 'paint-yellow';
	else
		return 'paint-red';
}

function floor_ed_mark_fim_generic($data, $fld)
{
	if (0) {
		print "<!-- GENERIC $fld\n";
		var_dump($data);
		print "-->\n";
	}

	if (!$data ||
	    !array_key_exists($fld, $data['FIM']['RAW'][0]))
		return;
	$toi = $data['FIM']['RAW'][0][$fld];
	if (6 <= $toi)
		return 'paint-blue';
	else if (4 <= $toi)
		return 'paint-yellow';
	else
		return 'paint-red';
}

function floor_ed_mark_fim_toi($data)
{
	return floor_ed_mark_fim_generic($data, '¥È¥¤¥ìÆ°ºî');
}

function floor_ed_mark_fim_und($data)
{
	return floor_ed_mark_fim_generic($data, 'Íý²ò');
}

function floor_ed_summarize_fim_data(&$data)
{
	$cog = array('Íý²ò' => 1,
		     'É½½Ð' => 1,
		     '¼Ò²ñÅª¸òÎ®' => 1,
		     'ÌäÂê²ò·è' => 1,
		     'µ­²±' => 1);
	$cogsum = array(0, 0);
	$physum = array(0, 0);
	$indiv = array(array(), array());
	foreach ($data as $col => $val) {
		$round = 0;
		if (substr($col, -2, 2) == '_1') {
			$round = 1;
			$col = substr($col, 0, -2);
		}
		if ($col == '°ÜÆ°¼êÃÊ') {
			$indiv[$round][$col] = $val;
			continue;
		}
		if (substr($col, -2, 2) != '_P')
			continue;
		$base = substr($col, 0, -2);
		if (array_key_exists($base, $cog)) {
			$cogsum[$round] += $val;
		}
		else {
			$physum[$round] += $val;
		}
		$indiv[$round][$base] = $val;
	}

	$sumsum = array(0, 0);
	for ($round = 0; $round < 2; $round++) {
		$physum[$round] -= min($indiv[$round]['¼Ö°Ø»Ò'],
				       $indiv[$round]['Êâ¹Ô']);
		$sumsum[$round] = $physum[$round] + $cogsum[$round];
	}
	return array('PHY' => $physum,
		     'COG' => $cogsum,
		     'SUM' => $sumsum,
		     'RAW' => $indiv);
}

function floor_ed_read_data($db, $theday, $today) {
 
	$d = array();
	$pi = array();
	$stmt = '
SELECT
  P."ObjectID", P."´µ¼ÔID", (P."À«" || P."Ì¾") AS "À«Ì¾",
  P."À­ÊÌ", P."Íø¤­¼ê", P."À¸Ç¯·îÆü", P."´¶À÷¾É", P."°å³ØÅªÉÔ°ÂÄê",
  P."²óÉü´ü", P."È¯¾ÉÆü", P."Æþ±¡Æü", P."Âà±¡Í½ÄêÆü", P."Âà±¡Í½Äê¡¦¸«¹þ",
  P."´õË¾ÉÂÅï", P."Æþ³°¶èÊ¬",

  (CASE WHEN P."À­ÊÌ" = \'M\' THEN \'ÃË\'
   WHEN P."À­ÊÌ" = \'F\' THEN \'½÷\'
   ELSE \'ÉÔÌÀ\' END) as "DDÀ­ÊÌ",
  (CASE WHEN P."Íø¤­¼ê" = \'R\' THEN \'±¦\'
   WHEN P."Íø¤­¼ê" = \'L\' THEN \'º¸\'
   WHEN P."Íø¤­¼ê" = \'r\' THEN \'±¦(¶ºÀµ)\'
   ELSE \'ÉÔÌÀ\' END) as "DDÍø¤­¼ê",
  COALESCE(to_char(P."À¸Ç¯·îÆü", \'YYYY-MM-DD\'), \'ÉÔÌÀ\')
      as "DDÀ¸Ç¯·îÆü",
  COALESCE(to_char(P."È¯¾ÉÆü", \'YYYY-MM-DD\'), \'-\')
      as "DDÈ¯¾ÉÆü",
  COALESCE(to_char(P."Æþ±¡Æü", \'YYYY-MM-DD\'), \'-\')
      as "DDÆþ±¡Æü",
  COALESCE(to_char(P."Âà±¡Í½ÄêÆü", \'YYYY-MM-DD\'), \'-\')
      as "DDÂà±¡Í½ÄêÆü",

  BC."ÉÂ¾²", BC."ÀêÍ­³«»Ï", BC."ÀêÍ­½ªÎ»",
  W."ÉÂÅïÌ¾", R."ÉÂ¼¼Ì¾", R."Äê¿ô",
  BC."ÉÂ¼¼", BC."ÀêÍ­¼Ô"
FROM
  "´µ¼ÔÂæÄ¢" AS P
LEFT JOIN
  "ÉÂ¾²´ÉÍý" AS BC
    ON (BC."ÀêÍ­¼Ô" = P."ObjectID") AND
       (BC."ÀêÍ­³«»Ï" <= \'' . $theday . '\') AND
       NOT (BC."ÀêÍ­½ªÎ»" <= \'' .  $theday . '\')
LEFT JOIN
 "ÉÂ¼¼°ìÍ÷É½" AS R ON BC."ÉÂ¼¼" = R."ObjectID"
LEFT JOIN
 "ÉÂÅï°ìÍ÷É½" AS W ON R."ÉÂÅï" = W."ObjectID"
WHERE
  P."Superseded" IS NULL AND
  (
    ( (P."Æþ³°¶èÊ¬" IN (\'I\', \'W\')) AND
      (P."Æþ±¡Æü" <= \'' . $theday . '\') AND
      (NOT (P."Âà±¡Í½ÄêÆü" <= \'' . $theday . '\')) ) OR
    ( \'' . $theday . '\' < \'' . $today . '\' AND
      BC."ÀêÍ­³«»Ï" IS NOT NULL ) )
ORDER BY
  P."ObjectID"
';
	if (0) {
		print "<!--";
		print $stmt;
		print "-->";
	}
//0820-2012
//print "SQL=".$stmt;
//0820-2012
	$sth = pg_query($db, $stmt);
	$result = pg_fetch_all($sth);
	if (!$result) { $result = array(); }
	$w = 0;
	foreach ($result as $v) {
		if ($v['ÉÂ¼¼Ì¾'] && $v['ÉÂ¾²']) { 
			$b = $v['ÉÂ¼¼Ì¾'] . '.' . $v['ÉÂ¾²'];
		}
		else {
			$w++;
			$b = 'wait' . '.' . $w;
		}
		$oid = $d[$b] = $v['ObjectID'];
		$fim = array();
		__lib_u_everybody_ps_anew_fim_fetch('N', $oid, $db, &$fim, 2);
		// we could pass &$v and add everything...
		if (0) {
			print "<!-- FIM $oid\n";
			var_dump($fim);
			print "-->\n";
		}
		$v['FIM'] = floor_ed_summarize_fim_data(&$fim);
		if (0) {
			print "<!-- FIM SUM $oid\n";
			var_dump($v['FIM']);
			print "-->\n";
		}
		$in = strtotime($v['Æþ±¡Æü']);
		$cur = strtotime($theday);
		$v['ºß±¡Æü¿ô'] = round(($cur - $in) / 3600 / 24);

		$pi[$oid] = $v;
	}

	$stmt = "
SELECT R.\"ÉÂ¼¼Ì¾\", B.\"ÉÂ¾²\",
       P.\"´µ¼ÔID\", (P.\"À«\" || P.\"Ì¾\") AS \"À«Ì¾\",
       min(B.\"ÀêÍ­³«»Ï\") AS \"ÀêÍ­\", B.\"ÀêÍ­½ªÎ»\"
FROM
    \"ÉÂ¾²´ÉÍý\" AS B
JOIN
    \"ÉÂ¼¼°ìÍ÷É½\" AS R
ON
    B.\"ÉÂ¼¼\" = R.\"ObjectID\"
JOIN
    \"´µ¼ÔÂæÄ¢\" AS P
ON
    B.\"ÀêÍ­¼Ô\" = P.\"ObjectID\"
WHERE
    '$theday' <= \"ÀêÍ­³«»Ï\"
GROUP BY R.\"ÉÂ¼¼Ì¾\", B.\"ÉÂ¾²\", B.\"ÀêÍ­³«»Ï\", B.\"ÀêÍ­½ªÎ»\",
 P.\"´µ¼ÔID\", P.\"À«\", P.\"Ì¾\"
HAVING  B.\"ÀêÍ­³«»Ï\" = min(B.\"ÀêÍ­³«»Ï\")
";
	$sth = pg_query($db, $stmt);
	$esdata = pg_fetch_all($sth);
	if (!$esdata) { $esdata = array(); }
	$es = array();
	foreach ($esdata as $v) {
		$match = array();
		$t = '¶õ';
		if (preg_match('/^(\d+)-(\d+)-(\d+) \d+:\d+:\d+(?:\.\d+)?$/',
			       $v["ÀêÍ­"], &$match)) {
			$bf = sprintf("%04d/%02d/%02d",
				      $match[1], $match[2], $match[3]);
			$b = sprintf("%02d/%02d", $match[2], $match[3]);
		}
		if (preg_match('/^(\d+)-(\d+)-(\d+) \d+:\d+:\d+(?:\.\d+)?$/',
			       $v["ÀêÍ­½ªÎ»"], &$match)) {
			$e = sprintf("%04d/%02d/%02d",
				     $match[1], $match[2], $match[3]);
		}
		if ($b && $bf && $e) {
			$es[$v["ÉÂ¼¼Ì¾"].'.'.$v["ÉÂ¾²"]] =
				array('begin' => $b,
				      'begin-full' => $bf,
				      'end-full' => $e,
				      'patient-id' => $v["´µ¼ÔID"],
				      'patient-name' => $v["À«Ì¾"]);
		}
	}
	$esdata = $es;

	$stmt = 'SELECT R."ÉÂ¼¼Ì¾", R."Äê¿ô" FROM "ÉÂ¼¼°ìÍ÷É½" AS R';
	$sth = pg_query($db, $stmt);
	$result = pg_fetch_all($sth);
	if (!$result) { $result = array(); }
	$sth = pg_query($db, $stmt);
	$result = pg_fetch_all($sth);
	if (!$result) { $result = array(); }
	foreach ($result as $v) {
		$r = $v['ÉÂ¼¼Ì¾'];
		$c = $v['Äê¿ô'];
		for ($i = 1; $i <= $c; $i++) {
			$k = $r . '.' . $i;
			if (!array_key_exists($k, $d)) {
				$d[$k] = 0;
				if (array_key_exists($k, $esdata))
					$es[$k] = $esdata[$k];
			}
		}
	}
	return array('floor-data' => $d,
		     'patient-info' => $pi,
		     'empty-schedule' => $es);
}

/* This probably needs to be kept when database view switches from "where
 * are things right now" model to "who occupies which slot during what
 * timerange".  But the array itself should come from the database.
 */
function initialize_session(&$db, $theday, $today) {
	global $__ses_table;
	$session = mx_db_allocate_unused_id(&$db, $__ses_table . "_ID_seq");


	$d = floor_ed_read_data(&$db, $theday, $today);
	if (0) {
		print "<!--";
		var_dump($d);
		print "-->";
	}
	$d = serialize($d);

	mx_db_insert_tuple(&$db, $__ses_table,
			   array('ID' => $session, 'data' => $d));
	return $session;
}

function floor_ed_locate(&$db, $pt, $ymd)
{
	global $__dbg;
	
	$__dbg .= "<br /> locate $pt $ymd";
	$p = mx_db_sql_quote($pt);
	$t = mx_db_sql_quote($ymd);
	$stmt = 'SELECT
  P."ObjectID", P."Æþ±¡Æü", P."Âà±¡Í½ÄêÆü", P."Âà±¡Í½Äê¡¦¸«¹þ",
  BC."ÀêÍ­³«»Ï", BC."ÀêÍ­½ªÎ»", BC."ÀêÍ­¼Ô",
  BC."ÉÂ¼¼", BC."ÉÂ¾²"
FROM
  "ÉÂ¾²´ÉÍý" AS BC
JOIN
  "´µ¼ÔÂæÄ¢" AS P
    ON BC."ÀêÍ­¼Ô" = P."ObjectID"
WHERE
  P."ObjectID" = '. $p . ' AND
  BC."ÀêÍ­³«»Ï" <= ' . $t . ' AND NOT (BC."ÀêÍ­½ªÎ»" <= ' . $t . ')';
	return mx_db_fetch_single(&$db, $stmt);
}

/* Kick out $pt at $ymd from all beds */
function floor_ed_vacate(&$db, $pt, $ymd, &$pcr)
{
	global $__dbg;
	$__dbg .= "<br />vacate $pt $ymd";
	$res = floor_ed_locate($db, $pt, $ymd);
	if (!$res) {
		$__dbg .= "<br />vacate no current.";
		return;
	}
	$room = $res['ÉÂ¼¼'];

	/* The occupants of the room is going to change */
	$pcr[$room] = 1;

	$bed = $res['ÉÂ¾²'];
	if ($res['ÀêÍ­³«»Ï'] == $ymd) {
		$ymd = mx_db_sql_quote($ymd);
		$t2_q = mx_db_sql_quote($res['ÀêÍ­½ªÎ»']);
		$stmt = 'DELETE FROM "ÉÂ¾²´ÉÍý" WHERE
  "ÉÂ¼¼" = '.$room.' AND "ÉÂ¾²" = '.$bed.' AND "ÀêÍ­¼Ô" = '.$pt.' AND
  "ÀêÍ­³«»Ï" = '.$ymd.' AND "ÀêÍ­½ªÎ»" = '.$t2_q;
		$__dbg .= "<br />" . htmlspecialchars($stmt);
		pg_query($db, $stmt);
	}
	else {
		$ymd = mx_db_sql_quote($ymd);
		$t1_q = mx_db_sql_quote($res['ÀêÍ­³«»Ï']);
		$t2_q = mx_db_sql_quote($res['ÀêÍ­½ªÎ»']);
		$stmt = 'UPDATE "ÉÂ¾²´ÉÍý" SET "ÀêÍ­½ªÎ»" = '.$ymd.' WHERE
  "ÉÂ¼¼" = '.$room.' AND "ÉÂ¾²" = '.$bed.' AND "ÀêÍ­¼Ô" = '.$pt.' AND
  "ÀêÍ­³«»Ï" = '.$t1_q.' AND "ÀêÍ­½ªÎ»" =  '.$t2_q;
		$__dbg .= "<br />" . htmlspecialchars($stmt);
		pg_query($db, $stmt);
	}
}

function floor_ed_locate_occupant(&$db, $room, $bed, $ymd)
{
	global $__dbg;
	
	$__dbg .= "<br /> locate-occupant $room $bed $ymd";
	$ymd_q = mx_db_sql_quote($ymd);
	$room_q = mx_db_sql_quote($room);
	$bed_q = mx_db_sql_quote($bed);
	$stmt = 'SELECT
  P."ObjectID", P."Æþ±¡Æü", P."Âà±¡Í½ÄêÆü", P."Âà±¡Í½Äê¡¦¸«¹þ",
  BC."ÀêÍ­³«»Ï", BC."ÀêÍ­½ªÎ»", BC."ÀêÍ­¼Ô",
  BC."ÉÂ¼¼", BC."ÉÂ¾²"
FROM
  "ÉÂ¾²´ÉÍý" AS BC
JOIN
  "´µ¼ÔÂæÄ¢" AS P
    ON BC."ÀêÍ­¼Ô" = P."ObjectID"
WHERE
  BC."ÉÂ¼¼" = '.$room_q.' AND BC."ÉÂ¾²" = '.$bed_q.' AND
  BC."ÀêÍ­³«»Ï" <= '.$ymd_q.' AND NOT (BC."ÀêÍ­½ªÎ»" <= '.$ymd_q.')';
	$__dbg .= "<br /> $stmt";
	return mx_db_fetch_single(&$db, $stmt);
}

function floor_ed_next_use(&$db, $room, $bed, $ymd)
{
	global $__dbg;
	$__dbg .= "<br />next-use $room $bed $ymd";
	$ymd_q = mx_db_sql_quote($ymd);
	$room_q = mx_db_sql_quote($room);
	$bed_q = mx_db_sql_quote($bed);
	$stmt = 'SELECT
  BC."ÉÂ¾²", BC."ÀêÍ­³«»Ï", BC."ÀêÍ­½ªÎ»", BC."ÉÂ¼¼", BC."ÀêÍ­¼Ô"
FROM
  "ÉÂ¾²´ÉÍý" AS BC
WHERE
  BC."ÉÂ¼¼" = '.$room_q.' AND BC."ÉÂ¾²" = '.$bed_q.' AND '.$ymd_q.' <= BC."ÀêÍ­³«»Ï"
ORDER BY
  BC."ÀêÍ­³«»Ï"
LIMIT 1';
	$__dbg .= "<br />next-use $stmt";
	return mx_db_fetch_single(&$db, $stmt);
}

function floor_ed_next_assigned(&$db, $pt, $ymd)
{
	global $__dbg;
	$__dbg .= "<br />next-assigned $pt $ymd";
	/* When will the $pt have any assignment after $ymd */
	$pt_q = mx_db_sql_quote($pt);
	$ymd_q = mx_db_sql_quote($ymd);
	$stmt = '
SELECT
  BC."ÉÂ¾²", BC."ÀêÍ­³«»Ï", BC."ÀêÍ­½ªÎ»", BC."ÉÂ¼¼", BC."ÀêÍ­¼Ô"
FROM
  "ÉÂ¾²´ÉÍý" AS BC
WHERE
  BC."ÀêÍ­¼Ô" = '.$pt_q.' AND '.$ymd_q.' <= BC."ÀêÍ­³«»Ï"
ORDER BY
  BC."ÀêÍ­³«»Ï"
LIMIT 1';
	return mx_db_fetch_single(&$db, $stmt);
}

function floor_ed_coalesce_use(&$db, $pt, $room, $bed, $ymd, $pt_end)
{
	global $__dbg;

	$__dbg .= "<br />coalesce $pt $room $bed $ymd $pt_end";
	/* If $pt's use of $room/$bed ends at $ymd, extend its use til
	 * $pt_end.  At this point we know the bed is unused between
	 * $ymd and $pt_end.
	 */
	$ymd_q = mx_db_sql_quote($ymd);
	$room_q = mx_db_sql_quote($room);
	$bed_q = mx_db_sql_quote($bed);
	$pt_q = mx_db_sql_quote($pt);
	$pt_end_q = mx_db_sql_quote($pt_end);
	$stmt = 'SELECT 
  BC."ÉÂ¾²", BC."ÀêÍ­³«»Ï", BC."ÀêÍ­½ªÎ»", BC."ÉÂ¼¼", BC."ÀêÍ­¼Ô"
FROM
  "ÉÂ¾²´ÉÍý" AS BC
WHERE
  BC."ÉÂ¼¼" = '.$room_q.' AND BC."ÉÂ¾²" = '.$bed_q.' AND
  '.$ymd_q.' = BC."ÀêÍ­½ªÎ»" AND BC."ÀêÍ­¼Ô" = '.$pt_q;
	$res = mx_db_fetch_single($db, $stmt);

	$__dbg .= "<br /> ". htmlspecialchars($stmt);
	if (!$res) {
		$__dbg .= "<br />No result.";
		return NULL;
	}
	$cbeg = $res['ÀêÍ­³«»Ï'];
	$cend = $res['ÀêÍ­½ªÎ»'];
	$cbeg_q = mx_db_sql_quote($cbeg);
	$cend_q = mx_db_sql_quote($cend);

	$beg = $cbeg;
	if ($ymd < $beg)
		$beg = $ymd;
	$beg_q = mx_db_sql_quote($beg);
	$stmt = 'UPDATE "ÉÂ¾²´ÉÍý"
SET
  "ÀêÍ­³«»Ï" = '.$beg_q.',
  "ÀêÍ­½ªÎ»" = '.$pt_end_q.'
WHERE
  "ÉÂ¼¼" = '.$room_q.' AND "ÉÂ¾²" = '.$bed_q.' AND
  "ÀêÍ­³«»Ï" = '.$cbeg_q.' AND
  "ÀêÍ­½ªÎ»" = '.$cend_q.' AND
  "ÀêÍ­¼Ô" = '.$pt_q;
	$__dbg .= "<br /> ". htmlspecialchars($stmt);
	pg_query($db, $stmt);
	return 1;
}

function floor_ed_occupy(&$db, $pt, $room, $bed, $ymd, &$pcr)
{
	global $__dbg;

	/* room needs to be converted to its object id */
	$room_q = mx_db_sql_quote($room);
	$stmt = 'SELECT "ObjectID" FROM "ÉÂ¼¼°ìÍ÷É½"
WHERE "ÉÂ¼¼Ì¾" = '.$room_q.' AND "Superseded" IS NULL';
	$room_obj = mx_db_fetch_single(&$db, $stmt);
	if (!$room_obj)
		die("OOPS? $room");
	$room_obj = $room_obj['ObjectID'];

	$__dbg .= "<br /> occupy $pt $room ($room_obj) $bed $ymd";

	/* Where is the patient on that day? */
	$current = floor_ed_locate($db, $pt, $ymd);
	if ($current) {
		if ($current['ÉÂ¼¼'] == $room_obj &&
		    $current['ÉÂ¾²'] == $bed) {
			$__dbg .= "<br /> $pt already at $room $bed";
			return; /* already there */
		}
		$__dbg .= "<br /> $pt at " .
			htmlspecialchars($current['ÉÂ¼¼']) . " " .
			htmlspecialchars($current['ÉÂ¾²']);
		floor_ed_vacate($db, $pt, $ymd, &$pcr);
		/* Double check */
		$current = floor_ed_locate($db, $pt, $ymd);
		if ($current) {
			$__dbg .= "<br />OOPS $pt $room $bed $ymd";
		}
	}

	/* At this point, we know that the room's occupants may change */
	$pcr[$room_obj] = 1;

	/* Who occupies that bed on that day? */
	$current = floor_ed_locate_occupant($db, $room_obj, $bed, $ymd);
	if ($current)
		floor_ed_vacate($db, $current['ObjectID'], $ymd, &$pcr);

	/* When will the bed used first after that day? */
	$next = floor_ed_next_use($db, $room_obj, $bed, $ymd);

	$pt_q = mx_db_sql_quote($pt);
	$discharge = 'SELECT "Âà±¡Í½ÄêÆü" FROM "´µ¼ÔÂæÄ¢"
WHERE "ObjectID" = '.$pt_q;
	$discharge = mx_db_fetch_single($db, $discharge);
	if (!$discharge)
		die("OOPS? discharge $pt_q");
	$pt_end = $discharge['Âà±¡Í½ÄêÆü'];

	/* When will the patient have a place to stay after $ymd? */
	$next_assigned = floor_ed_next_assigned($db, $pt, $ymd);
	if ($next_assigned) {
		$pt_end = $next_assigned['ÀêÍ­³«»Ï'];
	}

	/* At this point, $pt_end is the end of the occupation period.
	 * There are a few cases:
	 * (0) If that bed is occupied up to that date by the patient,
	 *     coalesce_use will extend that use. 
	 * (1) If the bed is unused after ymd, give it to the patient
	 *     until $pt_end by adding a new entry between $ymd..$pt_end.
	 * (2) If the bed is used after ymd by somebody else, give it
	 *     to the patient until $pt_end.
	 * (3) If the bed is used by the same patient, extend its use
	 *     till $discharge date.
	 */

	$__dbg .= "<br />pt-end is $pt_end, next[o] is " . $next['ÀêÍ­³«»Ï'];
	if (!$next) {
		if (floor_ed_coalesce_use($db, $pt, $room_obj, $bed,
					  $ymd, $pt_end))
			return;
		$ymd_q = mx_db_sql_quote($ymd);
		$room_q = mx_db_sql_quote($room_obj);
		$bed_q = mx_db_sql_quote($bed);
		$t1_q = mx_db_sql_quote($pt_end);
		$stmt = 'INSERT INTO "ÉÂ¾²´ÉÍý"
("ÉÂ¼¼", "ÉÂ¾²", "ÀêÍ­³«»Ï", "ÀêÍ­½ªÎ»", "ÀêÍ­¼Ô")
VALUES ('.$room_q.', '.$bed_q.', '.$ymd_q.', '.$t1_q.', '.$pt_q.')';
		$__dbg .= "<br />" . htmlspecialchars($stmt);
		pg_query($stmt);
		return;
	}
	else if ($next['ÀêÍ­¼Ô'] != $pt) {
		if (floor_ed_coalesce_use($db, $pt, $room_obj, $bed,
					  $ymd, $pt_end))
			return;
		$ymd_q = mx_db_sql_quote($ymd);
		$room_q = mx_db_sql_quote($room_obj);
		$bed_q = mx_db_sql_quote($bed);
		$t1_q = mx_db_sql_quote($pt_end);
		$t2_q = mx_db_sql_quote($next['ÀêÍ­³«»Ï']);
		$smaller = ($pt_end < $next['ÀêÍ­³«»Ï']) ? $t1_q : $t2_q;

		$stmt = 'INSERT INTO "ÉÂ¾²´ÉÍý"
("ÉÂ¼¼", "ÉÂ¾²", "ÀêÍ­³«»Ï", "ÀêÍ­½ªÎ»", "ÀêÍ­¼Ô")
VALUES ('.$room_q.', '.$bed_q.', '.$ymd_q.', '.$smaller.', '.$pt_q.')';
		pg_query($stmt);
		return;
	}
	else if ($next['ÀêÍ­³«»Ï'] == $pt_end) {
		$t2_q = mx_db_sql_quote($next['ÀêÍ­³«»Ï']);
		$stmt = 'DELETE FROM "ÉÂ¾²´ÉÍý"
WHERE "ÀêÍ­¼Ô" = '.$pt_q.' AND  "ÀêÍ­³«»Ï" = '.$t2_q;
		pg_query($stmt);
		$__dbg .= "<br />$stmt";
		return floor_ed_occupy($db, $pt, $room, $bed, $ymd, &$pcr);
	}
	else {
		$ymd_q = mx_db_sql_quote($ymd);
		$t2_q = mx_db_sql_quote($next['ÀêÍ­³«»Ï']);
		$stmt = 'UPDATE  "ÉÂ¾²´ÉÍý" SET "ÀêÍ­³«»Ï" = '.$ymd_q.'
WHERE "ÀêÍ­¼Ô" = '.$pt_q.' AND  "ÀêÍ­³«»Ï" = '.$t2_q;
		pg_query($stmt);
		return;
	}
}

/* Compute and update the floor allocation */
function floor_ed_occupies(&$db, $pt, $slot, $ymd, &$pcr)
{
	if (substr($slot, 0, 5) == 'wait.') {
		/* Kick out from the current slot */
		floor_ed_vacate(&$db, $pt, $ymd, &$pcr);
	}
	else {
		$pos = strpos($slot, '.');
		if ($pos === FALSE)
			return; /* OOPS */
		$room = substr($slot, 0, $pos);
		$bed = substr($slot, $pos+1);
		floor_ed_occupy(&$db, $pt, $room, $bed, $ymd, &$pcr);
	}
}

/*
 * Adjust the room-patient table if the change involves "today"
 */
function update_room_patient(&$db, $room, $today)
{
	global $u;
	global $__dbg;

	$stmt = <<<SQL
SELECT R."ÉÂ¼¼Ì¾", R."Äê¿ô" FROM "ÉÂ¼¼°ìÍ÷É½" AS R WHERE "ObjectID" = $room
SQL;
	$it = mx_db_fetch_single($db, $stmt);
	$c = $it['Äê¿ô'];
	$n = $it['ÉÂ¼¼Ì¾'];
	$occupant = array();
	for ($bed = 1; $bed <= $c; $bed++) {
		$o = floor_ed_locate_occupant($db, $room, $bed, "$today");
		if ($o && $o['ObjectID']) {
			$__dbg .= "Found " . $o['ObjectId'];
			$occupant[$o['ObjectID']] = 1;
		} else {
			$__dbg .= "Not Found";
		}
	}
	$stmt = <<<SQL
SELECT RD."´µ¼Ô", RP."ObjectID", RP."ÆüÉÕ", RP."CreatedBy"
FROM "ÉÂ¼¼´µ¼ÔÉ½" RP
LEFT JOIN "ÉÂ¼¼´µ¼Ô¥Ç¡¼¥¿" RD ON RD."ÉÂ¼¼´µ¼ÔÉ½" = RP."ObjectID"
WHERE RP."ÉÂ¼¼" = $room AND RP."Superseded" IS NULL
SQL;
	$sth = pg_query($db, $stmt);
	$current = pg_fetch_all($sth);
	if (!$current) {
		$current = array();
		$object_id = NULL;
		$date = NULL;
		$old_u = NULL;
	} else {
		$object_id = $current[0]['ObjectID'];
		$date = mx_db_sql_quote($current[0]['ÆüÉÕ']);
		$old_u = mx_db_sql_quote($current[0]['CreatedBy']);
		if (is_null($current[0]['´µ¼Ô']))
			$current = array();
	}
	$differs = 0;
	if (count($current) == count($occupant)) {
		foreach ($current as $o) {
			$o = $o['´µ¼Ô'];
			if (!array_key_exists($o['´µ¼Ô'], $occupant)) {
				$differs = 1;
				break;
			}
		}
	} else {
		$differs = 1;
	}
	$__dbg .= "<br />STMT $stmt";
	$__dbg .= "<br />OOO $object_id";
	$__dbg .= "<br />DDD $date";
	$__dbg .= "<br />UUU $old_u";

	if (!$differs && !is_null($object_id))
		return;

	/*
	 * We need to update the room-patient table
	 */
	$id = mx_db_allocate_unused_id($db, "ÉÂ¼¼´µ¼ÔÉ½_ID_seq");
	$new_u = mx_db_sql_quote($u);

	if ($object_id) {
		$stmt = <<<SQL
INSERT INTO "ÉÂ¼¼´µ¼ÔÉ½"
("ID", "ObjectID", "Superseded", "CreatedBy", "ÉÂ¼¼", "ÆüÉÕ")
VALUES ($object_id, $id, now(), $old_u, $room, $date)
SQL;
		$__dbg .= "<br />STMT $stmt";
		pg_query($db, $stmt);
		$stmt = <<<SQL
UPDATE "ÉÂ¼¼´µ¼Ô¥Ç¡¼¥¿"
SET "ÉÂ¼¼´µ¼ÔÉ½" = $id WHERE "ÉÂ¼¼´µ¼ÔÉ½" = $object_id
SQL;
		$__dbg .= "<br />STMT $stmt";
		pg_query($db, $stmt);

		$stmt = <<<SQL
UPDATE "ÉÂ¼¼´µ¼ÔÉ½" SET "CreatedBy" = $new_u, "ÆüÉÕ" = '$today'
WHERE "ObjectID" = $object_id;
SQL;
		$__dbg .= "<br />STMT $stmt";
		pg_query($db, $stmt);
	} else {
		$object_id = $id;
		$stmt = <<<SQL
INSERT INTO "ÉÂ¼¼´µ¼ÔÉ½"
("ID", "ObjectID", "Superseded", "CreatedBy", "ÉÂ¼¼", "ÆüÉÕ")
VALUES ($object_id, $object_id, NULL, $new_u, $room, '$today')
SQL;
		$__dbg .= "<br />STMT $stmt";
		pg_query($db, $stmt);
	}

	foreach ($occupant as $o => $junk) {
		$stmt = <<<SQL
INSERT INTO "ÉÂ¼¼´µ¼Ô¥Ç¡¼¥¿"
("ÉÂ¼¼´µ¼ÔÉ½", "´µ¼Ô")
VALUES ($object_id, $o)
SQL;
		$__dbg .= "<br />STMT $stmt";
		pg_query($db, $stmt);
	}
}

function update_room_patients($db, $pcr, $today)
{
	foreach ($pcr as $room => $one)
		update_room_patient(&$db, $room, $today);
}

/* The callers of this do not have to change, but this function itself
 * needs to be majorly rewritten for the world-model switch.
 *
 * This takes an action "$update" from the browser that says:
 * 	"pickit=<patientID>"
 * and responsible for returning a $data array, whose contents
 * are:
 * 
 * 	bed-ident => patient-id
 *	active	  => patient-id
 * 
 * bed-ident are typically of form 'room-name.number' (e.g. "901.1"),
 * or 'wait.number' (e.g. "wait.1", "wait.2", ...).
 * The HTML template should use:
 * 	<tag id="bed-ident"><?php o(bed-ident) ?></tag>
 * to mark the location on the map.  For wait area, say: 
 * 	<tag id="wait"><?php o(wait) ?></tag>
 * because the template should not care how many are waiting.
 *
 * patient-id 0 means unoccupied, and nobody active.
 *
 * It not just updates the session but updates the database.
 */
function update_session(&$db, $update, $session, $session_data, $theday,
			$today, $read_only) {
	global $__ses_table, $__dbg;

	$ymd = sprintf("%s 00:00:00", $theday);
	$__dbg = '';
	$d = $session_data;
	$data = $d['floor-data'];
	$pi = $d['patient-info'];
	$es = $d['empty-schedule'];

	if (!$update)
		return $d;

	if (substr($update, 0, 7) == 'pickit=') {
		$update = substr($update, 7);

		$pcr = array(); /* potentially_changed_room */

		/*
		 * Look for which slot the active thing is in
		 * and swap them.  Make the other active.
		 */
		$active_slot = $data['active'];
		if ($active_slot)
			$active = $data[$active_slot];
		else {
			$active = 0;
			$active_slot = NULL;
		}

		$pt = $data[$update];
		if (!$active || $read_only) {
			/* Nothing was active, so just activate the
			 * chosen, if it is not empty.
			 *
			 * In a read-only application, we just
			 * deactivate the active one, and activate
			 * the newly chosen one, if it is not empty.
			 */
			if ($pt) {
				$active = $pt;
				$active_slot = $update;
			}
			else {
				$active = 0;
				$active_slot = NULL;
			}
		}
		else if ($update == $active_slot) {
			/* Deactivate */
			$active = 0;
			$active_slot = NULL;
		}
		else if (!$pt) {
			/* Moving active one to an empty place */
			floor_ed_occupies($db, $active, $update, $ymd, &$pcr);
			$data[$active_slot] = NULL;
			$data[$update] = $active;
			$active = 0;
			$active_slot = NULL;
		}
		else {
			$__dbg .= "<br />?? $update vs $active_slot";
			/* Moving active one to an occupied place.
			 * Swap them and make the bumped one active.
			 */
			floor_ed_occupies($db, $active, $update, $ymd, &$pcr);
			$data[$update] = $active;
			floor_ed_occupies($db, $pt, $active_slot, $ymd, &$pcr);
			$data[$active_slot] = $pt;
			$active = $pt;
		}

		/* Clean it up */
		$newdata = array();
		foreach ($data as $slot => $junk) {
			if (substr($slot, 0, 5) == 'wait.')
				continue;
			if ($slot == 'active')
				continue;
			$newdata[$slot] = $junk;
		}
		for ($j = $i = 1;
		     array_key_exists("wait.$i", $data);
		     $i++) {
			if ($data["wait.$i"]) {
				$newdata["wait.$j"] = $data["wait.$i"];
				$j++;
			}
		}
		if (!$active_slot ||
		    substr($active_slot, 0, 5) == 'wait.' ||
		    $read_only)
			;
		else
			$newdata["wait.$j"] = 0;
		if ($active_slot)
			$newdata['active'] = $active_slot;

		$data = $newdata;
		$__dbg .= "<br />Active is $active_slot";

		if ($pcr) {
			$__dbg .= "<br />Potentially these rooms would change";
			$__dbg .= implode(",", array_keys($pcr));
			update_room_patients($db, $pcr, $today);
		}

	}

	$d = array('floor-data' => $data,
		   'patient-info' => $pi,
		   'empty-schedule' => $es);
	$into = serialize($d);
	$stmt = ("UPDATE \"$__ses_table\" SET " .
		 "data = " . mx_db_sql_quote($into) .
		 "\nWHERE \"ID\" = " . $session);
	pg_query($db, $stmt);
	return $d;
}

/* This stuffs the HTML representation for each slot in the $ddata
 * array for presentation, out of given $data.
 */
function format_ddata($db, $d, $opts) {
	global $__lib_u_manage_floor_ed_coloring_ix_to_label;
	$ix_to_label = $__lib_u_manage_floor_ed_coloring_ix_to_label;
	$coloring = $opts['coloring'];
	$color_ward_map = array();

	# If you want to highlight soon-to-be-discharged pt, based on
	# the calendar date, use "theday", otherwise use "today".
	$base_time = mx_datetime_to_unixtime($opts['theday'] . " 00:00");

	$ddata = array();
	$occupies = array();
	$data = $d['floor-data'];
	$empty_schedule = $d['empty-schedule'];
	$pi = $d['patient-info'];
	$active = $data['active'];
	$active_pt = NULL;
	$active_pt_ptid = NULL;
	$soon_discharge = array();
//print "PI===";
//print_r($pi);

	foreach ($data as $slot => $junk) {
		$aa = '';
		$class = array();
		$is_wait = (substr($slot, 0, 5) == 'wait.');
		$aa .= " onclick=\"pickit('$slot')\"";
		$dst = $is_wait ? 'wait' : $slot;
		if ($junk) {
			$aa .= ("onmouseover=\"tip('tip-$junk')\" " .
				"onmouseout=\"untip()\"");
			$ji = $pi[$junk];
			if ($slot == $active) {
				$class[] = 'active';
				$active_pt = $junk;
				$active_pt_ptid = $ji['´µ¼ÔID'];
			}

			$j = $ji['´õË¾ÉÂÅï'];
			$pn = $ji['À«Ì¾'];

			if ($ji['Æþ³°¶èÊ¬'] == 'W') {
				$class[] = 'pending';
			}
			$dis_time = mx_datetime_to_unixtime($ji['Âà±¡Í½ÄêÆü'] .
							    " 00:00");
			if ($dis_time != -1 && $base_time != -1 &&
			    $base_time <= $dis_time &&
			    $dis_time <= $base_time + 86400*7) {
				$class[] = 'soon';
				$a_name = $pn;
				$a_date = substr($ji['Âà±¡Í½ÄêÆü'], 5);
				if ($ji['ÉÂ¼¼Ì¾'])
					$a_name = "$pn (" . $ji['ÉÂ¼¼Ì¾'] . ")";
				$soon_discharge[] = "$a_date $a_name";
			}

			if ($dst == 'wait' && $j != '') {
				$pn = ($pn . "($j)");
			}
			$pn = htmlspecialchars($pn);
			$occupies[$junk] = $slot;
		}
		else {
			if (array_key_exists($slot, $empty_schedule)) {
				$aa .= ("onmouseover=\"tip('tip-b-$slot')\" " .
					"onmouseout=\"untip()\"");
				$pn = $empty_schedule[$slot]['begin'];
			}
			else
				$pn = "(¶õ¤­)";
		}

		if (count($class)) {
			$aa .= ' class="' . implode(' ', $class) . '"';
		}
		$it = ("<a$aa>$pn</a>");

		$around = '';
		if ($junk && 0 <= $coloring) {
			switch ($ix_to_label[$coloring]) {
			case '£Æ£É£ÍÁí¹ç':
				$around = floor_ed_mark_fim($pi[$junk]);
				break;
			case '£Æ£É£Í°ÜÆ°':
				$around = floor_ed_mark_fim_mobil($pi[$junk]);
				break;
			case '£Æ£É£Í¥È¥¤¥ì':
				$around = floor_ed_mark_fim_toi($pi[$junk]);
				break;
			case '£Æ£É£ÍÍý²ò':
				$around = floor_ed_mark_fim_und($pi[$junk]);
				break;
			case '²óÉü':
				$around = floor_ed_mark_reha_class($pi[$junk]);
//0820-2012 add am-pm number of yoyaku
//print "ABC=";
//print_r($pi[$junk]);

 if ($pi[$junk]['ÉÂ¼¼'] <49  ) {
					$around = 'paint-blue';
				}
				else  
					$around = 'paint-red';
				 
				break;
			case 'À­ÊÌ':
				if ($pi[$junk]['À­ÊÌ'] == 'M') {
					$around = 'paint-blue';
				}
				else if ($pi[$junk]['À­ÊÌ'] == 'F') {
					$around = 'paint-red';
				}
				break;
			case 'ºß±¡Æü¿ô':
				$around = floor_ed_mark_stay($pi[$junk]);
				break;
			case '´¶À÷¾É':
				if ($pi[$junk]['´¶À÷¾É'] != '') {
					$around = 'paint-red';
				}
				break;
			case '°å³ØÅªÉÔ°ÂÄê':
				$toi = $pi[$junk]['°å³ØÅªÉÔ°ÂÄê'];
				if ($toi == 'U') {
					$around = 'paint-red';
				}
				else if ($toi == 'W') {
					$around = 'paint-yellow';
				}
				break;
			default:
				break;
			}
			$ward = $pi[$junk]['ÉÂÅïÌ¾'];
			if (is_null($ward))
				$ward = '';
			if (!array_key_exists($ward, $color_ward_map))
				$color_ward_map[$ward] = array();
			if (!array_key_exists($around,$color_ward_map[$ward]))
				$color_ward_map[$ward][$around] = 0;
			$color_ward_map[$ward][$around]++;
		}

		if ($around) {
			$it = ("<span class=\"padded $around\">$it</span>");
		}

		if (!array_key_exists($dst, $ddata)) {
			$ddata[$dst] = '';
		} else {
			$ddata[$dst] .= '<br />';
		}
		$ddata[$dst] .= $it;
	}
	if (0) {
		print "<!-- OCC\n";
		var_dump($occupies);
		print "-->";
	}
	$legend = array();
	switch ($ix_to_label[$coloring]) {
	case '£Æ£É£ÍÁí¹ç':
		$legend = array('paint-blue' => '¹ç·×ÅÀ²þÁ± 5 ÅÀ°Ê¾å',
				'paint-green' => '¹ç·×ÅÀ²þÁ± 3 ÅÀ°Ê¾å',
				'paint-yellow' => '¹ç·×ÅÀ°­²½ 3 ÅÀ°Ê²¼',
				'paint-pink' => '¹ç·×ÅÀ°­²½ 5 ÅÀ°Ê²¼',
				'paint-red' => '¹ç·×ÅÀ°­²½ 5 ÅÀ°Ê¾å');
		break;
	case '£Æ£É£Í°ÜÆ°':
		$legend = array('paint-blue' => 'Êâ¹Ô',
				'paint-yellow' => '¼Ö°Ø»Ò¡Ê5 ÅÀ°Ê¾å)',
				'paint-red' => '¼Ö°Ø»Ò¡Ê5 ÅÀÌ¤Ëþ)');
		break;
	case '£Æ£É£Í¥È¥¤¥ì':
		$legend = array('paint-blue' => '¥È¥¤¥ì¡Ê6 ÅÀ°Ê¾å¡Ë',
				'paint-yellow' => '¥È¥¤¥ì¡Ê4 ÅÀ°Ê¾å)',
				'paint-red' => '¥È¥¤¥ì¡Ê4 ÅÀÌ¤Ëþ)');
		break;
	case '£Æ£É£ÍÍý²ò':
		$legend = array('paint-blue' => 'Íý²ò¡Ê6 ÅÀ°Ê¾å¡Ë',
				'paint-yellow' => 'Íý²ò¡Ê4 ÅÀ°Ê¾å)',
				'paint-red' => 'Íý²ò¡Ê4 ÅÀÌ¤Ëþ)');
		break;
	case '²óÉü':
//0813-2012
		$legend = array('paint-blue' => '²óÉü ',
				'paint-red' => '²óÉü');
		break;
	case 'À­ÊÌ':
		$legend = array('paint-blue' => 'ÃË',
				'paint-red' => '½÷');
		break;
	case 'ºß±¡Æü¿ô':
		$legend = array('paint-red' => 'ºß±¡ 150 Æü°Ê¾å',
				'paint-yellow' => 'ºß±¡ 90 Æü°Ê¾å',
				'paint-blue' => 'ºß±¡ 60 Æü°Ê¾å',
				'paint-green' => 'ºß±¡ 60 ÆüÌ¤Ëþ');
		break;
	case '´¶À÷¾É':
		$legend = array('paint-red' => '´¶À÷¾É¤¢¤ê');
		break;
	case '°å³ØÅªÉÔ°ÂÄê':
		$legend = array('paint-red' => '°å³ØÅªÉÔ°ÂÄê',
				'paint-yellow' => 'Í×Ãí°Õ');
		break;
	default:
		break;
	}
	$ddata['legend'] = $legend;
	$ddata['legend-stat'] = $color_ward_map;
	$ddata['occupies'] = $occupies;
	$ddata['schedule'] = '';
	$ddata['active-pt'] = $active_pt;
	$ddata['active-pt-ptid'] = $active_pt_ptid;
	if ($active_pt) {
		/* For the active patient, show schedule table */
		$name = $pi[$active_pt]['À«Ì¾'];
		$ent = $pi[$active_pt]['Æþ±¡Æü'] . " 00:00:00";
		$dis = $pi[$active_pt]['Âà±¡Í½ÄêÆü'] . " 00:00:00";
		$stmt = '
SELECT W."ÉÂÅïÌ¾", R."ÉÂ¼¼Ì¾", BC."ÉÂ¾²", BC."ÀêÍ­³«»Ï", BC."ÀêÍ­½ªÎ»"
FROM
  "ÉÂ¾²´ÉÍý" AS BC
JOIN
  "ÉÂ¼¼°ìÍ÷É½" AS R ON BC."ÉÂ¼¼" = R."ObjectID"
JOIN
 "ÉÂÅï°ìÍ÷É½" AS W ON R."ÉÂÅï" = W."ObjectID"
JOIN
  "´µ¼ÔÂæÄ¢" AS P
    ON (BC."ÀêÍ­¼Ô" = P."ObjectID")
WHERE BC."ÀêÍ­¼Ô" = '.mx_db_sql_quote($active_pt).'
ORDER BY BC."ÀêÍ­³«»Ï"';
		$sch2data = array();
		$result = pg_fetch_all(pg_query($db, $stmt));
		if ($result) {
			foreach ($result as $row) {
				$cnt = count($sch2data);
				$beg = $row['ÀêÍ­³«»Ï'];
				if ($cnt == 0)
					$last = $ent;
				else
					$last = $sch2data[$cnt-1]['ÀêÍ­½ªÎ»'];
				if ($last < $beg) {
					$sch2data[] =
						array('ÀêÍ­³«»Ï' => $last,
						      'ÀêÍ­½ªÎ»' => $beg);
				}
				$sch2data[] = $row;
			}
		}
		$cnt = count($sch2data);
		$beg = $row['ÀêÍ­³«»Ï'];
		if ($cnt == 0)
			$last = $ent;
		else
			$last = $sch2data[$cnt-1]['ÀêÍ­½ªÎ»'];
		if ($last < $dis) {
			$sch2data[] =
				array('ÀêÍ­³«»Ï' => $last,
				      'ÀêÍ­½ªÎ»' => $dis);
		}

		$sch0 = ('<table width="480px">'.
			 '<tr>'.
			 '<th colspan="2" align="left">´µ¼Ô»áÌ¾</td>'.
			 '<th colspan="3" align="left">'.
			 htmlspecialchars($name).
			 '</th>'.
			 '</tr>');
		$sch1 = ('<tr>'.
			 '<th width="120px">ÉÂÅï</th>'.
			 '<th width="60px">ÉÂ¼¼</th>'.
			 '<th width="60px">ÉÂ¾²</th>'.
			 '<th width="120px">¼«</th>'.
			 '<th width="120px">»ê</th>'.
			 '</tr>');
		foreach ($sch2data as $row) {
			$fm = $row['ÀêÍ­³«»Ï'];
			$to = $row['ÀêÍ­½ªÎ»'];
			if (substr($fm, 11) == '00:00:00')
				$fm = substr($fm, 0, 10);
			if (substr($to, 11) == '00:00:00')
				$to = substr($to, 0, 10);
			if (array_key_exists('ÉÂ¾²', $row))
				$sch2 .= ('<tr><td>'.
					  htmlspecialchars($row['ÉÂÅïÌ¾']).
					  '</td><td>'.
					  htmlspecialchars($row['ÉÂ¼¼Ì¾']).
					  '</td><td>'.
					  htmlspecialchars($row['ÉÂ¾²']).
					  '</td>');
			else
				$sch2 .= ('<tr><td colspan="3">'.
					  '<span class="paint-red">³äÅö¤Ê¤·'.
					  '</span></td>');
			$sch2 .= ('<td>'.
				  htmlspecialchars($fm).'</td>'.
				  '<td>'.
//0722-2012
				  htmlspecialchars($to).'</td>'.
				  '</tr>');

					  
		}
		$ddata['schedule'] = $sch0 . $sch1 . $sch2 . '</table>';
	}
	$ddata['soon-discharge'] = $soon_discharge;
	return $ddata;
}

function check_session($session, &$db) {
	global $__ses_table, $__dbg;
	if ($session) {
		$data = mx_db_fetch_single($db, 'SELECT "ID" FROM "' .
					   $__ses_table .
					   '" WHERE "ID" = ' . $session);
		if (!$data)
			return NULL;
		return $session;
	}
	return NULL;
}

function ask_for_confirmation($session_data) {
	global $_mx_resource_dir;
	print '<html>
<meta http-equiv="content-type" content="text/html; charset=euc-jp">
<link rel="stylesheet" href="/' . $_mx_resource_dir . '/mxstyle.css" />
<script language="JavaScript"
 src="/' . $_mx_resource_dir . '/mx.js"></script>
</head>
<body>
²áµî¤Îµ­Ï¿¤òÊÑ¹¹¤·¤è¤¦¤È¤·¤Æ¤¤¤Þ¤¹¤¬´Ö°ã¤¤¤Ê¤¤¤Ç¤¹¤Í¡©
<form method="POST">';
	if (1) {
		print "<!--\n";
		var_dump($_REQUEST);
		print "active = " . $session_data['floor-data']['active'];
		print "-->\n";
	}
	foreach ($_POST as $k => $v) {
		mx_formi_hidden($k, $v);
	}
	mx_formi_submit('ok_to_backdate', 1,
		"<img src=\"/$_mx_resource_dir/images/continue_button.png\">");
	mx_formi_submit('ok_to_backdate', 0,
		"<img src=\"/$_mx_resource_dir/images/abort_button.png\">");
	print "</form></body></html>\n";
}

function main($read_only) {
	global $__this_output_data, $__calendar;
	global $__lib_u_manage_floor_ed_coloring_label_to_ix;
	global $__lib_u_manage_floor_ed_coloring_button_breaks;
	global $__ses_table, $__dbg;
	global $auth;
	global $__lib_u_manage_floor_ed_floors;

	$db = mx_db_connect();

	/* Check if there is an existing session */
	$session = check_session($_REQUEST['session'], &$db);

	/* Handle non 'update' requests.  E.g. 'calendar' */
	$__calendar = new floor_ed_calendar('calendar', array());
	$ymd = $__calendar->chosen();
	$today = strftime('%Y-%m-%d', time());
	if (!$ymd) {
		$__calendar->reset(NULL, NULL, $today);
		$ymd = $__calendar->chosen();
	}
	$theday = sprintf("%04d-%02d-%02d", $ymd[0], $ymd[1], $ymd[2]);
	$in_the_past = ($theday < $today);
	if ($__calendar->changed()) {
		$session = NULL;
	}
	if (array_key_exists('floor', $_REQUEST) &&
	    substr($_REQUEST['floor'], 0, 7) == 'pickit=') {
		$floor = substr($_REQUEST['floor'], 7);
	}
	else {
		$user_info = mx_prepare_userinfo($auth);
		$section = $user_info["Éô½ðÌ¾"];
		$floor = NULL;
		foreach ($__lib_u_manage_floor_ed_floors as $ig => $fcfg) {
			if (is_null($floor) ||
			    ($section == $fcfg['section']))
			    $floor = $ig;
		}
	}
	if (array_key_exists('color', $_REQUEST) &&
	    substr($_REQUEST['color'], 0, 7) == 'pickit=') {
		$coloring = substr($_REQUEST['color'], 7);
	}
	else {
		$coloring = -1;
	}

	/* Get data out of the database as needed */
	if (!$session) {
 
		$session = initialize_session(&$db, $theday, $today);
	}
 
	/* If we are looking at historical data, and if we already have
	 * somebody we picked, picking somewhere else would swap them,
	 * but we would need a confirmation before doing so.
	 *
	 * If $_REQUEST['update'] is pickit=<slot>, and
	 * the patient in that slot is not already active,
	 * and if $theday is earlier tan $today,
	 * and if we do not have the OK to proceed, ask for that.
	 */
	$session_data = mx_db_fetch_single($db, 'SELECT data FROM "' .
					   $__ses_table .
					   '" WHERE "ID" = ' . $session);
	$session_data = unserialize($session_data['data']);

	if (array_key_exists('ok_to_backdate', $_REQUEST) &&
	    !$_REQUEST['ok_to_backdate'])
		$_REQUEST['update'] = 'unset';

	if (! (array_key_exists('ok_to_backdate', $_REQUEST) &&
	       $_REQUEST['ok_to_backdate']) &&
	    $in_the_past && !$read_only &&
	    (substr($_REQUEST['update'], 0, 7) == 'pickit=')) {
		$update_slot = substr($_REQUEST['update'], 7);
		$active_slot = $session_data['floor-data']['active'];
		if ($active_slot != '' && $update_slot != $active_slot) {
			return ask_for_confirmation($session_data);
		}
	}
	$data = update_session(&$db, $_REQUEST['update'], $session,
			       $session_data, $theday, $today, $read_only);
	$capcolor = $__lib_u_manage_floor_ed_floors[$floor]['caption_color'];
	$floorcolor = $__lib_u_manage_floor_ed_floors[$floor]['floor_color'];

	$opts = array('capcolor' => $capcolor,
		      'floorcolor' => $floorcolor,
		      'coloring' => $coloring,
		      'floor' => $floor,
		      'today' => $today,
		      'theday' => $theday);
	$__this_output_data = format_ddata(&$db, $data, $opts);

	draw_header($opts, $data, $__this_output_data);
	print '<input type="hidden" name="update" id="update" value="unset">';
	print '<input type="hidden" name="floor" id="floor" value="pickit=';
	print $floor;
	print '">';
	print '<input type="hidden" name="color" id="color" value="pickit=';
	print $coloring;
	print '">';
	print '<input type="hidden" name="session" value="';
	print $session;
	print "\">\n";

	print "<strong>";
	print htmlspecialchars($auth[1]);
	print "</strong>\n";
	mx_draw_ppa_applist($__this_output_data['active-pt-ptid']);
	print "<hr />\n";
//0925-2014
	print "<table><tr><td><strong>FLOOR</strong></td><td>";
	foreach ($__lib_u_manage_floor_ed_floors as $ident => $floorcfg) {
		$label = $floorcfg['label'];
		if ($floor == $ident) {
			print "&nbsp;<img src=\"/images/floor";
		print $ident;
			print "_s.png\" align=\"absbottom\">";
		}
		else {
			print "&nbsp;<a onclick=\"floorit('";
			print $ident;
			print"')\">";
			print "<img src=\"/images/floor";
			print $ident;
			print ".png\" align=\"absbottom\">";
			print "</a>\n";
		}
	}
	print "</td></tr>\n";

	print "<tr><td><strong>¿§Ê¬¤±</strong></td><td>";
	foreach ($__lib_u_manage_floor_ed_coloring_label_to_ix
		 as $label => $ident) {
		if (array_key_exists
		    ($label,
		     $__lib_u_manage_floor_ed_coloring_button_breaks))
			print "</td></tr><tr><td>&nbsp;</td><td>";
		if ($coloring == $ident) {
			print "&nbsp;<a onclick=\"colorit('-1')\">";
			print "&nbsp;<img src=\"/images/coloring";
			print $ident;
			print "_s.png\" align=\"absbottom\">";
			print "</a>\n";
		}
		else {
			print "&nbsp;<a onclick=\"colorit('";
			print $ident;
			print"')\">";
			print "<img src=\"/images/coloring";
			print $ident;
			print ".png\" align=\"absbottom\">";
			print "</a>\n";
		}
	}
	print "</td></tr>";
	print "</table>\n";

	$draw_func = "draw_floor_" . $floor;
	$draw_func();
	draw_footer($session, $data);
}
?>
