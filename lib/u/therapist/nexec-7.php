<?php // -*- mode: php; coding: euc-japan -*-
include_once $_SERVER['DOCUMENT_ROOT'].'/lib/common.php';
include_once $_SERVER['DOCUMENT_ROOT'].'/lib/u/manage/simple-object.php';
include_once $_SERVER['DOCUMENT_ROOT'].'/lib/u/therapist/norder-2.php';

$_lib_u_therapist_execution_code_enum = array
('180022110' => 'Íý³ØÎÅË¡¡Ê¡Ë¸ÄÊÌ',
 '180022210' => 'Íý³ØÎÅË¡¡Ê¡Ë½¸ÃÄ',
 '180023610' => 'ºî¶ÈÎÅË¡¡Ê¡Ë¸ÄÊÌ',
 '180023710' => 'ºî¶ÈÎÅË¡¡Ê¡Ë½¸ÃÄ',
 '180024810' => '¸À¸ìÄ°³ÐÎÅË¡¡Ê¡Ë¸ÄÊÌ',
 '180024910' => '¸À¸ìÄ°³ÐÎÅË¡¡Ê¡Ë½¸ÃÄ');

function __lib_u_therapist_nexec_list_cfg(&$cfg) {
  $cfg = array_merge
    ($cfg, array
     ('TABLE' => '¥ê¥Ï¼Â»Üµ­Ï¿',
      'ALLOW_SORT' => array
      ('ObjectID' => array('¼Â»Üµ­Ï¿ID' => 'X."ObjectID"'),
       'ÆüÉÕ' => array('ÆüÉÕ' => 'X."ÆüÉÕ"'),
       '¼Â»ÜÎÅË¡»Î' => array('¼Â»ÜÎÅË¡»Î' => '(T."À«" || T."Ì¾")')),
      'DEFAULT_SORT' => 'ÆüÉÕ',
      'LCOLS' => array(array('Column' => 'ObjectID',
			     'Label' => '¼Â»Üµ­Ï¿ID'),
		       'ÆüÉÕ', '¼Â»ÜÎÅË¡»Î'),
      'ENABLE_QBE' =>
      array(array('Column' => 'ÆüÉÕ', 'Compare' => 'X."ÆüÉÕ"',
		  'Draw' => 'text'),
	    array('Column' => '¼Â»ÜÎÅË¡»Î',
		  'Compare' => '(T."À«" || T."Ì¾")',
		  'Draw' => 'text')),
      'UNIQ_ID' => 'X."ObjectID"',
      ));

  $stmt_head = '
SELECT X."ObjectID",
       X."ÆüÉÕ",
       (T."À«" || T."Ì¾") as "¼Â»ÜÎÅË¡»Î"
FROM "¥ê¥Ï¼Â»Üµ­Ï¿" as X
JOIN "¥ê¥Ï½èÊýäµ" as RX ON X."¥ê¥Ï½èÊýäµ" = RX."ID"
LEFT JOIN "¿¦°÷ÂæÄ¢" as T ON T."ObjectID" = X."¼Â»ÜÎÅË¡»Î"
';

  $cfg['HSTMT'] = $stmt_head . 'WHERE NULL IS NULL';
  $cfg['STMT'] = $stmt_head . 'WHERE X."Superseded" IS NULL';
}

class list_of_rehab_nexecs extends list_of_simple_objects {

  var $default_row_per_page = 4;
  var $debug = 1;

  function list_of_rehab_nexecs($prefix, $cfg=NULL) {
    if (is_null($cfg)) $cfg = array();
    $this->loo = new list_of_rehab_norders($prefix . 'loo-', $cfg);
    $this->sod = new rehab_norder_display($prefix . 'sod-', $cfg);

    if ($this->loo->changed() && $this->loo->chosen()) {
	    $this->sod->reset($this->loo->chosen());
	    $this->sod_changed = 1;
    }
    if (array_key_exists($prefix. 'OHistory', $_REQUEST))
	    $this->sod->history($_REQUEST[$prefix . 'OHistory']); 

    __lib_u_therapist_nexec_list_cfg(&$cfg);
    list_of_simple_objects::list_of_simple_objects($prefix, $cfg);

    if (!$this->sod->chosen())
	    return; 
    $this->Rx_ObjectID = $this->sod->chosen();
  }

  function lost_selection() {
	  return $this->sod_changed;
  }

  function reset($id) {
	  if (is_null($id)) {
		  $this->loo->reset($id);
		  $this->sod->reset($id);
		  $this->Rx_ObjectID = $this->sod->chosen();
	  }
	  list_of_simple_objects::reset($id);
  }

  function allow_new() {
	  if (!$this->sod->chosen())
		  return 0;
	  return 1;
  }

  function draw() {
	  $this->loo->draw();
	  if (!$this->Rx_ObjectID)
		  return;

	  print "<br />\n";
	  mx_titlespan('[¥ê¥ÏäµÆâÍÆ]');
	  $this->sod->draw();
	  $sod_history = $this->sod->history();
	  $oh = $this->prefix . 'OHistory';
	  if (($sod_history & 3) == 3)
		  mx_formi_submit($oh, 'Prev',
				  mx_img_url('history.png'),'ÍúÎò');
	  else {
		  if (($sod_history & 5) == 5)
			  mx_formi_submit($oh, 'Prev',
					  mx_img_url('history-prev.png'),
					  'Á°¤Ø');
		  if (($sod_history & 9) == 9)
			  mx_formi_submit($oh, 'Next',
					  mx_img_url('history-next.png'),
					  '¸å¤Ø');
	  }
	  print "<br />\n";
	  mx_titlespan('[¥ê¥Ï¼Â»Üµ­Ï¿]');
	  return list_of_simple_objects::draw();
  }

  function base_fetch_stmt_0() {
    return (list_of_simple_objects::base_fetch_stmt_0() .
	    ' AND RX."ObjectID" = ' .
	    mx_db_sql_quote($this->Rx_ObjectID));
  }

  function row_paging_orders() {
    $paging_keys = $this->row_paging_keys();
    $paging_orders = array();
    foreach ($paging_keys as $col) {
      $paging_orders[] = (($col == 'ÆüÉÕ') ? 1 : 0);
    }
    return $paging_orders;
  }

}

function __lib_u_therapist_nexec_cfg(&$cfg) {
	__lib_u_therapist_nexec_list_cfg(&$cfg);

	$select = 'SELECT
X."ID",
X."ÆüÉÕ",
X."¥ê¥Ï½èÊýäµ",
ET."ObjectID" as "¼Â»ÜÎÅË¡»Î",
(EE."À«" || \' \' || EE."Ì¾") as "µ­Ï¿¼Ô",
X."CreatedBy",
X."É¾²ÁS", X."É¾²ÁO", X."É¾²ÁA", X."É¾²ÁP"
FROM "¥ê¥Ï¼Â»Üµ­Ï¿" AS X
LEFT JOIN "¿¦°÷ÂæÄ¢" AS ET ON X."¼Â»ÜÎÅË¡»Î" = ET."ObjectID"
LEFT JOIN "¿¦°÷ÂæÄ¢" AS EE
	ON X."CreatedBy" = EE.userid AND EE."Superseded" IS NULL
';
	$cfg['HSTMT'] = $select . 'WHERE NULL IS NULL';
	$cfg['STMT'] = $select . 'WHERE X."Superseded" IS NULL';

	$cfg['DCOLS_BASE'] = array
		(array('Column' => '¥ê¥Ï½èÊýäµ',
		       'Label' => '¥ê¥Ï½èÊýäµ',
		       'Draw' => 'static',
		       'Page' => 0),
		 array('Column' => "ID",
		       'Label' => '¼Â»Üµ­Ï¿ID',
		       'Draw' => 'static',
		       'ICOLS-Exclude' => 1,
		       'Page' => 0),
		 array('Column' => 'ÆüÉÕ',
		       'Label' => 'ÆüÉÕ',
		       'Draw' => 'text',
		       'Option' => array('ime' => 'disabled'),
		       'Page' => 0),
		 array('Column' => '¼Â»ÜÎÅË¡»Î',
		       'Label' => '¼Â»ÜÎÅË¡»Î',
		       'Draw' => 'enum',
		       'Enum' => $cfg['EmployeeEnum'],
		       'Page' => 0),
		 array('Column' => 'µ­Ï¿¼Ô',
		       'Label' => 'µ­Ï¿¼ÔÌ¾',
		       'Draw' => 'static',
		       'ICOLS-Exclude' => 1,
		       'Page' => 0),
		 array('Column' => 'CreatedBy',
		       'Draw' => NULL,
		       'ICOLS-Exclude' => 1),
		 array('Column' => 'É¾²ÁS',
		       'Label' => 'É¾²ÁS',
		       'Draw' => 'textarea',
		       'Page' => 0),
		 array('Column' => 'É¾²ÁO',
		       'Label' => 'É¾²ÁO',
		       'Draw' => 'textarea',
		       'Page' => 0),
		 array('Column' => 'É¾²ÁA',
		       'Label' => 'É¾²ÁA',
		       'Draw' => 'textarea',
		       'Page' => 0),
		 array('Column' => 'É¾²ÁP',
		       'Label' => 'É¾²ÁP',
		       'Draw' => 'textarea',
		       'Page' => 0));

	$cfg['DPAGES'] = $cfg['DPAGES_BASE'] = array('¼Â»Üµ­Ï¿');
	$cfg['DCOLS'] = $cfg['DCOLS_BASE'];

	$cfg['EPAGES'] = $cfg['EPAGES_BASE'] = array('¼Â»Üµ­Ï¿');
	$cfg['ECOLS'] = $cfg['ECOLS_BASE'] = $cfg['DCOLS_BASE'];

	$cfg['ICOLS'] = array();
	foreach ($cfg['ECOLS_BASE'] as $d) {
		if (array_key_exists('ICOLS-Exclude', $d))
			continue;
		$cfg['ICOLS'][] = $d['Column'];
	}
}

function __lib_u_therapist_nexec_fetch_subs($id, &$data)
{
	$stmt = ('SELECT 
"ObjectID", "³«»ÏÆü»þ", "½ªÎ»Æü»þ", "·±Îý¾ì½ê", "·±ÎýÆâÍÆ",
"Ã±°Ì¿ô", "Ã±°Ì¼ïÊÌ", "¿ÇÎÅ¹Ô°Ù¥³¡¼¥É", "¥³¥á¥ó¥È"
FROM "¥ê¥Ï¼Â»Üµ­Ï¿ÆâÍÆ"
WHERE "¥ê¥Ï¼Â»Üµ­Ï¿" = ' . mx_db_sql_quote($id) . '
ORDER BY "ObjectID"');

	$db = mx_db_connect();
	$data1 = pg_fetch_all(pg_query($db, $stmt));
	if (!is_array($data1))
		return $data;
	for ($i = 1; $i <= count($data1); $i++) {
		$tum = $data1[$i-1];
		foreach ($tum as $k => $v) {
			$data["$i-$k"] = $v;
		}
	}
	return $data;
}

function __lib_u_therapist_nexec_unannotate_datetime($data, $v)
{
	/* Reverse annotation */
	$match = array();
	if (preg_match('/^\d+:\d+(?::\d+)?$/',
		       $v, &$match))
		$v = $data['ÆüÉÕ'] . " $v";
	return $v;
}

function __lib_u_therapist_nexec_annotate_datetime(&$data)
{
	$this_date = $data['ÆüÉÕ'];
	$last_i = __lib_u_therapist_nexec_count_subpage($data);
	for ($i = 1; $i <= $last_i; $i++) {
		foreach (array("³«»ÏÆü»þ", "½ªÎ»Æü»þ") as $k) {
			$v = $data["$i-$k"];
			$match = array();
			/* Full date -- is it the same day */
			if (preg_match('/^(\d+-\d+-\d+) (.*)$/',
				       $v, &$match) &&
			    $this_date == $match[1])
				$v = $match[2];
			if (preg_match('/(\d+:\d+):00$/', $v,
				       &$match))
				$v = $match[1];
			$data["$i-$k"] = $v;
		}
	}
}

function __lib_u_therapist_nexec_tweak_cfg(&$acols, &$apages, $fm, $to)
{
	global $_lib_u_therapist_execution_code_enum;
	for ($i = $fm; $i <= $to; $i++) {
		$acols[] = array('Column' => "$i-³«»ÏÆü»þ",
				      'Label' => "³«»ÏÆü»þ",
				      'Draw' => 'timestamp',
				      'Page' => $i);
		$acols[] = array('Column' => "$i-½ªÎ»Æü»þ",
				      'Label' => "½ªÎ»Æü»þ",
				      'Draw' => 'timestamp',
				      'Page' => $i);
		$acols[] = array('Column' => "$i-·±Îý¾ì½ê",
				      'Label' => "·±Îý¾ì½ê",
				      'Draw' => 'enum',
				      'Enum' =>
				      array('·±Îý¼¼' => '·±Îý¼¼',
					    'ÉÂ¼¼' => 'ÉÂ¼¼'),
				      'Page' => $i);
		$acols[] = array('Column' => "$i-·±ÎýÆâÍÆ",
				      'Label' => "·±ÎýÆâÍÆ",
				      'Draw' => 'text',
				      'Page' => $i);
		$acols[] = array('Column' => "$i-Ã±°Ì¿ô",
				      'Label' => "Ã±°Ì¿ô",
				      'Draw' => 'text',
				      'Option' => array('ime' => 'disabled'),
				      'Page' => $i);

		$acols[] = array('Column' => "$i-¿ÇÎÅ¹Ô°Ù¥³¡¼¥É",
				      'Label' => "¿ÇÎÅ¹Ô°Ù¥³¡¼¥É",
				      'Page' => $i,
				      'Draw' => 'enum',
				      'Enum' => $_lib_u_therapist_execution_code_enum);

		$acols[] = array('Column' => "$i-¥³¥á¥ó¥È",
				      'Label' => "¥³¥á¥ó¥È",
				      'Draw' => 'textarea',
				      'Page' => $i);
		$apages[] = "($i)";
	}
}

function __lib_u_therapist_nexec_count_subpage($data) {
	$last_i = 0;
	for ($i = 1;
	     array_key_exists("$i-³«»ÏÆü»þ", $data);
	     $i++) {
		$last_i = $i;
	}
	return $last_i;
}

class rehab_nexec_display extends simple_object_display {

	var $debug = 1;

	function rehab_nexec_display($prefix, $cfg=NULL) {
		if (is_null($cfg)) $cfg = array();
		__lib_u_therapist_nexec_cfg(&$cfg);
		simple_object_display::simple_object_display($prefix, $cfg);
	}

	function pre_draw_hook($data, $hdata) {
		$last_i = __lib_u_therapist_nexec_count_subpage($data);
		if ($hdata) {
			$ii = __lib_u_therapist_nexec_count_subpage($hdata);
			if ($last_i < $ii)
				$last_i = $ii;
		}

		$cfg =& $this->so_config;
		$dcols = $cfg['DCOLS_BASE'];
		$dpages = $cfg['DPAGES_BASE'];
		__lib_u_therapist_nexec_tweak_cfg(&$dcols,
						  &$dpages,
						  1, $last_i);
		$cfg['DCOLS'] = $dcols;
		$cfg['DPAGES'] = $dpages;
		simple_object_display::pre_draw_hook($data, $hdata);
	}

	function fetch_data($id) {
		$data = simple_object_display::fetch_data($id);
		return __lib_u_therapist_nexec_fetch_subs($id, &$data);
	}

	function annotate_row_data(&$data) {
		__lib_u_therapist_nexec_annotate_datetime(&$data);
	}

}

class rehab_nexec_edit extends simple_object_edit {

	var $debug = 1;

	function rehab_nexec_edit($prefix, $cfg=NULL) {
		if (is_null($cfg)) $cfg = array();
		__lib_u_therapist_nexec_cfg(&$cfg);
		simple_object_edit::simple_object_edit($prefix, $cfg);
	}

	function get_form_data() {
		# Slurp subpage fields from the $_REQUEST
		$i = 1;
		
		$cfg =& $this->so_config;
		$ecols = $cfg['ECOLS_BASE'];
		$epages = $cfg['EPAGES_BASE'];
		while (1) {
			$field = $this->en("$i-³«»ÏÆü»þ");
			if (!array_key_exists($field, $_REQUEST))
				break;
			__lib_u_therapist_nexec_tweak_cfg(&$ecols,
							  &$epages,
							  $i, $i);
			$i++;
		}
		$cfg['ECOLS'] = $ecols;
		$cfg['EPAGES'] = $epages;
		simple_object_edit::get_form_data();
		$this->add_empty_subpage_as_needed();
	}

	function add_empty_subpage_as_needed() {
		$last_i = __lib_u_therapist_nexec_count_subpage($this->data);
		$cfg =& $this->so_config;

		# If there are pages already, and the last one is empty,
		# there is no point adding any.  However, we want to
		# make sure its tab does not say "($last_i)".
		if (0 < $last_i && $this->is_empty_subpage($last_i)) {
			$cfg['EPAGES'][$last_i] = "¿·µ¬";
			return;
		}

		# Otherwise, we would add one page.
		$ecols = $cfg['ECOLS'];
		$epages = $cfg['EPAGES'];
		$last_i++;
		__lib_u_therapist_nexec_tweak_cfg(&$ecols,
						  &$epages,
						  $last_i, $last_i);
		$epages[$last_i] = "¿·µ¬";

		# For pages other than the last one, if the date-time
		# is empty, fill the default based on the current time.
		# But leave the new page empty.
		$now = time();
		$begintime = strftime('%H:%M', $now - 1200);
		$endtime = strftime('%H:%M', $now);
		for ($i = 1; $i < $last_i; $i++) {
			if ($this->data["$i-³«»ÏÆü»þ"] == '' &&
			    $this->data["$i-½ªÎ»Æü»þ"] == '') {
				$this->data["$i-³«»ÏÆü»þ"] = $begintime;
				$this->data["$i-½ªÎ»Æü»þ"] = $endtime;
			}
		}
		$cfg['ECOLS'] = $ecols;
		$cfg['EPAGES'] = $epages;
	}

	function is_empty_subpage($i, $data=NULL) {
		if (is_null($data))
			$data = $this->data;
		foreach (array('·±ÎýÆâÍÆ', 'Ã±°Ì¿ô', '¥³¥á¥ó¥È') as $fld) {
			if ($data["$i-$fld"] != '') {
				return 0;
			}
		}
		return 1;
	}

	function fetch_data($id) {
		$data = simple_object_edit::fetch_data($id);
		return __lib_u_therapist_nexec_fetch_subs($id, &$data);
	}

	function anew_edit_tweak() {
		$this->data['¥ê¥Ï½èÊýäµ'] = $this->Rx_ObjectID;
		$last_i = __lib_u_therapist_nexec_count_subpage($this->data);
		$cfg =& $this->so_config;
		$ecols = $cfg['ECOLS_BASE'];
		$epages = $cfg['EPAGES_BASE'];
		__lib_u_therapist_nexec_tweak_cfg(&$ecols, &$epages,
						  1, $last_i);
		$cfg['ECOLS'] = $ecols;
		$cfg['EPAGES'] = $epages;

		$this->add_empty_subpage_as_needed();
	}

	function anew_tweak($orig_id) {
		return $this->anew_edit_tweak();
	}

	function edit_tweak() {
		return $this->anew_edit_tweak();
	}

	function annotate_row_data(&$data) {
		__lib_u_therapist_nexec_annotate_datetime(&$data);
	}

	function annotate_form_data(&$data) {
		simple_object_edit::annotate_form_data(&$data);
		__lib_u_therapist_nexec_annotate_datetime(&$data);
	}

	function _validate($force=NULL) {
		$time_unit_err = $fatal_errs = $errs = 0;
		$d = $this->data;
//0426-2014
 
 
		if ($msg = mx_db_validate_date($d['ÆüÉÕ'])) {
			$this->err("ÆüÉÕ: $msg");
			$errs++;
			$fatal_errs++;
		}
 


		for ($i = 1;
		     array_key_exists("$i-³«»ÏÆü»þ", $d);
		     $i++) {
			if ($this->is_empty_subpage($i) &&
			    $d["$i-³«»ÏÆü»þ"] == '' &&
			    $d["$i-½ªÎ»Æü»þ"] == '')
				continue; // discard

			foreach (array('³«»ÏÆü»þ', '½ªÎ»Æü»þ') as $fld) {
				$v = __lib_u_therapist_nexec_unannotate_datetime($d, $d["$i-$fld"]);
				if ($msg = mx_db_validate_datetime($v)) {
					$this->err("$fld($i): $msg");
					$errs++;
					$fatal_errs++;
					$time_unit_err = 1;
				}
			}
			if ($msg = mx_db_validate_posint($d["$i-Ã±°Ì¿ô"])) {
				$this->err("Ã±°Ì¿ô($i): $msg");
				$errs++;
				$fatal_errs++;
				$time_unit_err = 1;
			}
			if (($msg = mx_db_validate_length
			     ($d["$i-¥³¥á¥ó¥È"], 1, 0)) &&
			    ($msg = mx_db_validate_length
			     ($d["$i-·±ÎýÆâÍÆ"], 1, 0))) {
				$this->err("¥³¥á¥ó¥È($i)¡¦·±ÎýÆâÍÆ($i)¤ÎÎ¾Êý¤¬¶õ¤Ç¤Ï¤¤¤±¤Þ¤»¤ó¡£");
				$errs++;
				$fatal_errs++;
			}
			if (!$time_unit_err) {
				$v = __lib_u_therapist_nexec_unannotate_datetime($d, $d["$i-³«»ÏÆü»þ"]);
				$begin = mx_datetime_to_unixtime($v);
				$v = __lib_u_therapist_nexec_unannotate_datetime($d, $d["$i-½ªÎ»Æü»þ"]);

				$end = mx_datetime_to_unixtime($v);
				$duration = $end - $begin;
				$units = $d["$i-Ã±°Ì¿ô"];

				if ($duration < $units * 20 * 60) {
					$minutes = floor($duration / 60);
					$seconds = $duration - $minutes * 60;
					$this->err("($i) ¤Î·±Îý»þ´Ö $minutes Ê¬ $seconds ÉÃ ¤¬".
						   " $units Ã±°Ì¤ËÂ­¤ê¤Þ¤»¤ó");
					$errs++;
				}
				else if (($units + 1) * 20 * 60 <= $duration) {
					$minutes = floor($duration / 60);
					$seconds = $duration - $minutes * 60;
					$this->err("($i) ¤Î·±Îý»þ´Ö $minutes Ê¬ $seconds ÉÃ ¤Ï".
						   " $units Ã±°Ì¤òÄ¶²á¤·¤Æ¤¤¤Þ¤¹");
					$errs++;
				}
			}
		}

		$this->error_override_allowed = (!$force && $fatal_errs == 0);

		if ($errs == 0 || (($fatal_errs == 0) && $force)) {
			$this->errmsg = '';
			return 'ok';
		}
 
//0430-2014
 
	}

	function data_compare($curr, $data) {
		if (simple_object_edit::data_compare($curr, $data))
			return 1;
		$names = array("³«»ÏÆü»þ", "½ªÎ»Æü»þ", "·±Îý¾ì½ê",
			       "·±ÎýÆâÍÆ", "Ã±°Ì¿ô", "Ã±°Ì¼ïÊÌ",
			       "¿ÇÎÅ¹Ô°Ù¥³¡¼¥É", "¥³¥á¥ó¥È");

		$last_c = __lib_u_therapist_nexec_count_subpage($curr);
		while (0 < $last_c) {
			if (!$this->is_empty_subpage($last_c, $curr))
				break;
			$last_c--;
		}
		$last_d = __lib_u_therapist_nexec_count_subpage($data);
		while (0 < $last_d) {
			if (!$this->is_empty_subpage($last_d, $data))
				break;
			$last_d--;
		}
		if ($last_c != $last_d)
			return 1;

		for ($i = 1; $i <= $last_c; $i++) {
			foreach ($names as $n) {
				if ($curr["$i-$n"] != $data["$i-$n"])
					return 1;
			}
		}
		return 0;
	}

	function _update_subtables(&$db, $id, $stash_id) {
		if (! is_null($stash_id)) {
			$stmt = ('
UPDATE "¥ê¥Ï¼Â»Üµ­Ï¿ÆâÍÆ" 
SET "¥ê¥Ï¼Â»Üµ­Ï¿" = ' . mx_db_sql_quote($stash_id) . '
WHERE "¥ê¥Ï¼Â»Üµ­Ï¿" = ' . mx_db_sql_quote($id));
			$this->dbglog("Stash-Subs: $stmt\n");
			if (! pg_query($db, $stmt))
				return pg_last_error($db);
		}
		$i = 1;
		$names = array("³«»ÏÆü»þ", "½ªÎ»Æü»þ", "·±Îý¾ì½ê",
			       "·±ÎýÆâÍÆ", "Ã±°Ì¿ô", "Ã±°Ì¼ïÊÌ",
			       "¿ÇÎÅ¹Ô°Ù¥³¡¼¥É", "¥³¥á¥ó¥È");
		while (1) {
			if (!array_key_exists("$i-³«»ÏÆü»þ", $this->data))
				break;
			if ($this->is_empty_subpage($i) &&
			    $d["$i-³«»ÏÆü»þ"] == '' &&
			    $d["$i-½ªÎ»Æü»þ"] == '') {
				$i++;
				continue; // discard
			}
			$time_begin = __lib_u_therapist_nexec_unannotate_datetime($this->data, $this->data["$i-³«»ÏÆü»þ"]);
			$time_end = __lib_u_therapist_nexec_unannotate_datetime($this->data, $this->data["$i-½ªÎ»Æü»þ"]);
			$stmt = ('
INSERT INTO "¥ê¥Ï¼Â»Üµ­Ï¿ÆâÍÆ"
("¥ê¥Ï¼Â»Üµ­Ï¿", "³«»ÏÆü»þ", "½ªÎ»Æü»þ", "·±Îý¾ì½ê",
 "·±ÎýÆâÍÆ", "Ã±°Ì¿ô", "Ã±°Ì¼ïÊÌ",
 "¿ÇÎÅ¹Ô°Ù¥³¡¼¥É", "¥³¥á¥ó¥È") VALUES
(' . mx_db_sql_quote($id) . ', ' .
mx_db_sql_quote($time_begin) . ', ' .
mx_db_sql_quote($time_end) . ', ' .
mx_db_sql_quote($this->data["$i-·±Îý¾ì½ê"]) . ', ' .
mx_db_sql_quote($this->data["$i-·±ÎýÆâÍÆ"]) . ', ' .
mx_db_sql_quote($this->data["$i-Ã±°Ì¿ô"]) . ', ' .
mx_db_sql_quote($this->data["$i-Ã±°Ì¼ïÊÌ"]) . ', ' .
mx_db_sql_quote($this->data["$i-¿ÇÎÅ¹Ô°Ù¥³¡¼¥É"]) . ', ' .
mx_db_sql_quote($this->data["$i-¥³¥á¥ó¥È"]) . ')');
			$this->dbglog("Insert-Subs: $stmt\n");
			if (! pg_query($db, $stmt))
				return pg_last_error($db);
			$i++; 
		}
		return '';
	}

}

?>
